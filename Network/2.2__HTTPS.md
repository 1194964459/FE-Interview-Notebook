# HTTPS

参考：

https://juejin.cn/post/6844903599303032845

https://juejin.cn/post/6844904094503550984

知乎（点赞人数多）：https://zhuanlan.zhihu.com/p/43789231  
菜鸟（简单易懂）：https://www.runoob.com/w3cnote/http-vs-https.html  

 
HTTPS = HTTP + 加密 + 认证 + 完整性保护  

http的不足：
* 通信使用未加密的明文，内容容易被窃取
* 不验证通信方的身份，容易遭遇伪装（https： 通过 CA 颁发的数字证书验证当前访问的事真实服务器）
* 无法验证报文的完整性，容易被篡改（https：哈希校验）

https就是为了解决上述http协议的安全性问题诞生的。https并非是应用层的新协议，是基于http协议的，将http和tcp协议接口部分用SSL和TLS协议代替而已。  
http: IP ➜ TCP ➜ HTTP（应用层）  
https: IP ➜ TCP ➜ SSL ➜ HTTP（应用层）  

###  一、加密
HTTPS 结合了**非对称加密**和**对称加密**的优势：

* **非对称加密**：用于*握手阶段传输 对称密钥*（如 RSA、ECC 算法）。有2 个密钥（密钥对）
    * 特点：有公钥（公开）和私钥（保密），公钥加密的数据仅私钥可解密，反之亦然。
    * 作用：安全传输对称密钥，避免密钥在传输中被窃听。

* **对称加密**：用于*实际数据传输*（如 AES、ChaCha20 算法）。只使用1 个密钥
    * 特点：加密和解密使用同一密钥，效率远高于非对称加密。
    * 作用：高效加密大量传输数据，保证通信性能。

> 基础知识了解：  
> 1. **对称加密**：用同一个密钥加密、解密。常用对称加密算法：AES，RC4，3DES     
> 2. **非对称加密**：用一个密钥加密的数据，必须使用另一个密钥才能解密。常用非对称加密算法：RSA，DSA/DSS  
> 3. **常用HASH算法**：MD5，SHA1（已不安全），SHA256  


### 二、HTTPS 的工作原理
* SSL（Secure Sockets Layer安全套接字层协议）
* TLS（Transport Layer Security传输层安全协议）

HTTPS 并非独立协议，而是在 HTTP 基础上加入了 **SSL（Secure Sockets Layer）** 或 **TLS（Transport Layer Security）** 协议（TLS 是 SSL 的升级版，目前主流使用 TLS 1.2/1.3）。其核心流程可分为三步：

**1. 握手阶段：协商加密算法和密钥**
握手阶段的目标是让客户端和服务器安全地协商出一个**对称加密密钥（会话密钥）**，用于后续数据传输。以主流的 TLS 1.2 为例，流程如下：

* **(1) 客户端发起请求**：客户端（如浏览器）向服务器发送：
    * 支持的 TLS 版本（如 TLS 1.2）。
    * 支持的加密套件列表（如 ECDHE-RSA-AES256-GCM-SHA384，包含密钥交换算法、对称加密算法、哈希算法）。
    * 客户端生成的随机数 Client Random（用于后续计算会话密钥）。
    * 扩展信息（如 SNI 服务器名称指示，用于多域名共享证书场景）。


* **(2) 服务器回应**：
    * 选定的 TLS 版本和加密套件（从客户端列表中选择，如 ECDHE-RSA-AES256-GCM-SHA384）。
    * 服务器生成的随机数 Server Random（同样用于计算会话密钥）。
    * 服务器证书（包含服务器公钥、域名、有效期、CA 签名等信息）。
    * （若使用 ECDHE 等密钥交换算法）服务器的临时公钥（用于生成预主密钥）。

    [数字证书的生成细节，请看“三、疑问❓ 发送者的公钥是如何拿到的呢”](./2.2.2__数字签名.md)

* **(3) 客户端验证证书**：
    * 客户端用内置的 **CA 根证书**验证服务器证书合法性：
        * 检查证书是否由可信 CA 签发（通过 CA 公钥验证证书上的 CA 签名）。
        * 确认证书未过期、域名与访问地址一致、未被吊销（通过 OCSP 或 CRL 检查）。
    * 若验证失败，浏览器会提示 “不安全” 警告，阻止用户继续访问（防钓鱼和伪造服务器）。

* **(4) 客户端生成预主密钥并传输**
    * 客户端生成随机数 Pre-master Secret（预主密钥）。
    * 用服务器证书中的**公钥**（或 ECDHE 临时公钥）加密 Pre-master Secret，发送给服务器。
    * （非对称加密的作用：只有服务器的私钥能解密此数据，确保 Pre-master Secret 仅服务器可见）。

* **(5) 双方计算会话密钥**
    * 服务器用**私钥**解密得到 Pre-master Secret。
    * 客户端和服务器分别使用 Client Random、Server Random、Pre-master Secret，通过**伪随机函数（PRF）** 计算出**会话密钥（对称密钥）**，包括：
        * 用于数据加密的**对称加密密钥**（如 AES 密钥）。
        * 用于完整性校验的**MAC 密钥**（如 HMAC 密钥）。
* **(6) 握手完成确认**
    * 客户端发送 “已准备好使用会话密钥加密通信” 的消息（用会话密钥加密）。
    * 服务器回应同样的确认消息（用会话密钥加密）。
    * 握手阶段结束，进入数据传输阶段。

**2. 数据传输阶段：对称加密通信**
握手完成后，客户端与服务器使用**对称加密算法**（如 AES）和会话密钥加密所有传输数据，确保数据机密性。

**3. 完整性校验：防止数据篡改**
通过**消息认证码（MAC）** 或 **HMAC（哈希消息认证码）** 对传输数据进行校验，确保数据未被篡改。


###  三、CA 证书包含的信息：：
CA（Certification Authority证书颁发机构）
* 公钥
* 网站地址
* 证书的颁发机构
* 过期时间

### 四、HTTPS 与 HTTP 的对比
|  特性   | HTTP  | HTTPS |
|  ----  | ----  | ---- | 
| 端口  | 80 | 403 | 
| 证书 | 无需 |	需 CA 颁发的数字证书 |
| 安全性 | 明文传输，无加密	| 加密传输，防窃听/篡改 |
| 速度 | 较快（无握手开销）| 稍慢（握手阶段耗时）|
| SEO 影响 |	无优势	| 谷歌等搜索引擎优先收录 |

<br/><br/><br/>
----------------------------------------------- 这个流程写的太口语了 -------------------------------------------------
###  三、https加密通信的流程：
1. 浏览器输入url请求网站，并附带自己支持的一套加密规则。
2. 网站制作证书，这个应该是网站建站的时候就已经弄好了。证书分为服务器证书和客户端证书，我们所说的证书一般都是指服务器证书（ssl证书详细解读）。制作过程如下：
    1. 制作CSR文件。就是制作Certificate Secure Request证书请求文件，制作过程中，系统会产生2个密钥，一个是公钥就是这个CSR文件，另一个是私钥，存在服务器上。
    2. CA认证。将CSR文件提交给CA，一般有两种认证方式：域名认证 和 企业文档认证。
    3. 证书安装。收到CA证书后，将证书部署在服务器上。
3. 网站从浏览器发过来的加密规则中选一组自身也支持的加密算法和hash算法，并向浏览器发送带有公钥的证书，当然证书还包含了很多信息，如网站地址、证书的颁发机构、过期时间等。
4. 浏览器解析证书。
    1. 验证证书的合法性。如颁发机构是否合法、证书中的网站地址是否与访问的地址一致，若不合法，则浏览器提示证书不受信任，若合法，浏览器会显示一个小锁头。
    2. 若合法，或用户接受了不合法的证书，浏览器会生成一串随机数的密码（即密钥），并用证书中提供的公钥加密。
    3. 使用约定好的hash计算握手消息，并使用生成的随机数（即密钥）对消息进行加密，最后将之前生成的所有消息一并发送给网站服务器。
5. 网站服务器解析消息。用已有的私钥将密钥解密出来，然后用密钥解密发过来的握手消息，并验证是否跟浏览器传过来的一致。然后再用密钥加密一段握手消息，发送给浏览器。
6. 浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。

下图表示https加密通信的过程： 
![非对称加密](./icon/encrypt.png)


### 问题
https中间被篡改了怎么识别？