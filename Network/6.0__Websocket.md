# Websocket

WebSocket 通过一次 HTTP 握手建立持久 TCP 连接，之后客户端与服务器可基于此连接双向实时收发数据，无需重复建立连接。

参考：[一个简单的 Websocket服务](/Users/yanglixia/Documents/ri-chang/2025/ws)

WebSocket 是一种基于 TCP 的全双工通信协议，允许**客户端与服务器建立持久连接**后进行***实时*、*双向*数据传输**。弥补了 HTTP协议“请求 - 响应” 模式的局限性，是实现实时通信的核心技术。

应用场景：如 聊天、实时数据更新、在线协作等对实时性要求高的场景。

## 核心原理
**1. 建立连接：HTTP 握手升级**   
Websocket 是基于一次特殊的 HTTP 请求 “升级” 而来：
* 客户端发送 HTTP 请求，携带头部 ```Upgrade: websocket``` 和 ```Connection: Upgrade```，表明要切换到 WebSocket 协议。
* 服务器确认后返回 ```101 Switching Protocols``` 响应，HTTP 连接正式升级为 WebSocket 连接（**底层仍基于 TCP**）。
* 握手成功后，客户端与服务器保持持久 TCP 连接，无需重复建立连接。

**2. 连接维护**
* 通过 “Ping/Pong” 帧机制检测连接状态：```服务器定期发送 Ping 帧，客户端回复 Pong 帧```，确保链路通畅。
* 任何一方可发送 “关闭帧” 主动终止连接，避免资源浪费。

## 优缺点

优点：
* 全双工实时通信
* 持久连接，低延迟
* 轻量高效：数据帧格式简洁，头部开销小（通常仅 2-14 字节）
* 支持跨域通信：服务器配置 Access-Control-Allow-Origin 控制权限

缺点：
* 兼容性问题：老旧浏览器不支持，需降级为长轮询等方案来支持
* 持久连接 会导致 服务器资源消耗较高

## 具体实现
### (一) 客户端实现
通过浏览器原生的 WebSocket 对象即可快速创建连接，核心步骤为「建立连接 → 监听事件 → 发送/接收数据」。

* 连接建立：
```js
// 1. 建立WebSocket连接（协议用ws，加密用wss，类似http/https）
const ws = new WebSocket('ws://localhost:3000');
```

* 监听事件，客户端核心事件有：
    * open（连接建立）、
    * message（接收消息）、error（错误）、close（连接关闭）。

* 发送数据：ws.send()

整体代码如下：
```js
// 1. 建立WebSocket连接（协议用ws，加密用wss，类似http/https）
const ws = new WebSocket('ws://localhost:3000');

// 2. 监听连接成功事件
ws.onopen = () => {
  console.log('连接服务器成功');
  // 向服务器发送数据（支持字符串、Blob、ArrayBuffer）
  ws.send('Hello WebSocket!');
};

// 3. 监听接收服务器消息事件
ws.onmessage = (event) => {
  console.log('收到服务器消息：', event.data);
};

// 4. 监听连接错误事件
ws.onerror = (error) => {
  console.error('连接出错：', error);
};

// 5. 监听连接关闭事件
ws.onclose = (event) => {
  console.log('连接已关闭，原因：', event.reason);
}
```

### （二）服务端实现
Node.js 需借助第三方库（如 ws，轻量常用）搭建 WebSocket 服务，核心是「创建服务 → 监听客户端连接 → 处理消息/连接」。

```js
// 引入ws库，创建WebSocket服务器
const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 3000 }); // 监听3000端口

// 监听客户端连接事件（每有一个客户端连入，就会触发一次）
wss.on('connection', (ws) => {
  console.log('新客户端已连接');

  // 监听当前客户端发送的消息
  ws.on('message', (message) => {
    console.log('收到客户端消息：', message.toString());
    // 向当前客户端回复消息
    ws.send(`服务器已收到：${message}`);

    // （可选）向所有已连接的客户端广播消息（如群聊功能）
    wss.clients.forEach((client) => {
      if (client.readyState === WebSocket.OPEN) {
        client.send(`[广播] ${message}`);
      }
    });
  });

  // 监听当前客户端断开连接
  ws.on('close', () => {
    console.log('客户端已断开连接');
  });
});

wss.on("listening", () => {
  console.log("服务器已启动，监听端口 8080");
});

```

服务器端核心事件：
* connection（新客户端连接）、
* listening（WebSocket 服务器成功启动并开始监听端口时）
* message（接收消息）、close（客户端断开）、error（服务器错误）、

