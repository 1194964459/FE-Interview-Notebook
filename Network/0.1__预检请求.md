# 预检请求 
**只有当一个请求是“非简单请求”，并且“跨域”时，浏览器才会发起预检请求**。任何一个条件不满足，浏览器就不会发起预检请求。如：一个没跨域的非简单请求。

预检请求的目的是 “询问服务器是否允许跨域操作”

### 疑问❓：为什么这样搞？  
答：出于安全考虑，浏览器的同源策略仅允许同源的资源进行访问与交互。CORS（跨域资源共享）是对同源策略的一种放宽，可允许跨域资源访问，但必须在安全的前提下进行：

需要前后端共同配合的：`① 前端 ----> ② 后端 ----> ③ 前端`，
`第③步`浏览器对后端的校验主要有：`有木有对应的头？头中的字段是不是与预期相符？只要有一个不符合，浏览器会阻止前端代码访问响应内容，即使服务器返回的 HTTP 状态码是 200`

* **跨域的简单请求**：这类请求的影响范围较小，浏览器会直接发送请求，但会在请求头中带上 Origin 字段，让服务器判断是否允许。服务器通过返回 Access-Control-Allow-Origin 来授权。
    > 对于简单请求，浏览器主要是校验 Access-Control-Allow-Origin 响应头是否符合上面👆🏻的规范。

* **跨域的非简单请求**：这类请求通常具有更强的 “副作用”（例如用 PUT 方法修改服务器数据）。因此，浏览器在发送实际请求前，浏览器会先发送一个 OPTIONS “预检请求”，用于询问服务器是否允许该复杂请求的跨域访问？服务器通过返回 Access-Control-Allow-Origin、Access-Control-Allow-Methods 这2个字段来授权。
    > 对于复杂请求，浏览器校验上面2个响应头是否**都符合上面👆🏻的规范**？若都符合 则校验通过，然后发送真实业务请求；否则拦截。以此平衡跨域需求与服务器安全。

* 携带凭证场景：当需要在跨域请求中携带凭证（如 Cookie ）时，如果服务器没有设置 `Access-Control-Allow-Credentials: true`，或者 `Access-Control-Allow-Origin 设置为 *`，浏览器会拒绝携带凭证，并且可能无法正常处理响应，导致前端无法实现基于凭证的跨域会话管理等功能。


## 预检请求
一、客户端发送一个预检请求，告知服务器“我这边会发送一个怎样的业务请求？Header、Method”
* 方法：OPTIONS
* 请求URL：与真实业务请求的 URL 完全一致
* 请求头（浏览器自动添加）：
    * **Host：目标服务器的域名**，与请求 URL一致。如：backend.com
    * **Origin：发起请求的源**，如：https://frontend.com
    * Access-Control-Request-Method：告知服务器 “真实业务请求将使用的 HTTP 方法”。
    * Access-Control-Request-Headers(**非必须**)：告知服务器 “真实请求将携带哪些头”。		
* 没有请求体

二、服务器收到预检请求后，返回以下字段，主要是告知客户端“我这边会 允许的Origin、Header、Method 啥的”：

必须项：
* Access-Control-Allow-Origin：服务器允许的前端源
    * 若服务器返回 `Access-Control-Allow-Origin: *`，表示允许所有源跨域访问（但如果请求需要携带 Cookie 等凭证，* 会失效，必须指定具体源）。
* Access-Control-Allow-Methods： 服务器允许客户端使用的请求方法

非必须项：
* Access-Control-Allow-Headers：服务器允许客户端请求中携带的字段
* Access-Control-Max-Age：预检响应的缓存时间，期间相同跨域请求无需重复发预检，减少请求次数。
* Access-Control-Allow-Credentials：**若前端请求携带 Cookie**（withCredentials: true），需返回 true，且 Access-Control-Allow-Origin 不能为 *。			

响应状态码：
* `204 No Content`（无内容）
* `200 OK`，但需确保响应体为空

三、浏览器校验预检响应的逻辑
只有预检请求校验通过后，才会发送真实业务请求！

## 真实请求如果携带Token、cookie是怎样的？
参考：[Fetch详情中的“XHR 和 Fetch 是如何对Cookie进行处理的”](./5.2__Fetch.md)，链接里的内容很重要！！！

不过这是真实请求的情况，需要在预检请求中做一下 method、header 相关的配置。

**即：以xhr为例，若想传递 cookie 需要满足 3 个条件**：
```js
web 请求设置withCredentials
Access-Control-Allow-Credentials 为 true
Access-Control-Allow-Origin为非 *
```