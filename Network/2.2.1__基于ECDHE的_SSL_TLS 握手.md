# 基于ECDHE 的 TLS 握手流程
基于ECDHE（Elliptic Curve Diffie-Hellman Ephemeral，“椭圆曲线临时”迪菲 - 赫尔曼） 算法的握手是目**前应用最广泛的安全握手方式**（**因支持前向安全性**）

### 核心前提
ECDHE 是一种**密钥交换算法**，其核心作用是：通过交换公钥，各自计算出相同的**预主密钥（Pre-Master Secret）**，再*基于预主密钥*生成用于加密后续通信的**主密钥（Master Secret） 和会话密钥**。

* 「**Ephemeral（临时）**」意味着**每次握手都会生成新的密钥对，即使后续会话被破解，历史通信也不会泄露（前向安全性）**。
* 「**椭圆曲线（EC）**」相比传统 DH 算法，**在相同安全性下密钥长度更短，计算效率更高**。

> 传统的 RSA 算法，是在客户端和服务器间直接传输对称密钥（Pre-Master Secret）

## TLS 1.2版本
整个过程可分为**4 个主要阶段**，涉及客户端、服务器、CA（证书颁发机构）三方交互，共传递 4 条关键消息：
### 一、阶段 1：客户端发起握手请求（Client Hello）
客户端向服务器发送第一条消息，包含以下关键信息：

* **支持的协议版本**：如 TLS 1.2。
* **客户端随机数（Client Random）**：一个 32 字节的随机数（用于后续生成主密钥）。
* **支持的椭圆曲线列表**：客户端支持的 EC 曲线（如 secp256r1、x25519 等，*x25519 是目前最常用的曲线之一*）。
* **支持的密码套件列表**：客户端可接受的加密套件，<code>格式为 “密钥交换算法 + 对称加密算法 + 哈希算法”</code>，如：
    > ECDHE-ECDSA-AES128-GCM-SHA256（ECDHE 密钥交换，ECDSA 签名，AES-128-GCM 对称加密，SHA256 哈希）   
    > ECDHE-RSA-AES256-GCM-SHA384（RSA 签名）。  
* **会话 ID（可选）**：若需复用会话可携带，此处为新会话则为空。

### 二、阶段 2：服务器响应（Server Hello + 证书 + 服务器密钥交换 + Server Hello Done）
服务器收到客户端请求后，依次返回 3 条消息：

**1. Server Hello**   
服务器确认握手参数：
* 选定的协议版本（如 TLS 1.2）。
* 服务器随机数（Server Random）：32 字节随机数（与客户端随机数共同用于生成主密钥）。
* 选定的椭圆曲线：从客户端列表中选一个（如 x25519）。
* 选定的密码套件：从客户端列表中选一个（如ECDHE-RSA-AES128-GCM-SHA256，表示用 RSA 对服务器的 ECDHE 公钥进行签名）。  

**2. Certificate（服务器证书）**     
服务器向客户端发送数字证书，包含：
* 服务器域名、**公钥**（服务器的 **RSA** 或 **ECDSA 公钥**，用于*验证后续的数字签名*）。
* 证书颁发机构（CA）的信息及 CA 对证书的数字签名（客户端将通过 CA 根证书验证此签名，确认服务器身份）。
[数字证书的具体生成](./2.2.2__数字签名.md)

**3. Server Key Exchange（服务器密钥交换）**    
这是 *ECDHE 握手的核心消息，服务器生成临时 ECDHE 密钥对并发送*：
* 服务器的**临时 ECDHE 公钥（Server ECDHE Public Key）**：基于选定的椭圆曲线生成（如 x25519 公钥），客户端将用此公钥计算共享密钥。
* **数字签名**：*服务器用自己的私钥*（*CA证书中对应公钥的私钥，如 RSA 私钥*）对以下内容签名，*防止公钥被篡改*：
    * **服务器临时 ECDHE 公钥**。
    * **客户端随机数（Client Random）**和**服务器随机数（Server Random）**（*确保签名与当前会话绑定*）。

**4. Server Hello Done**   
服务器通知客户端：“我的响应已完成，请继续”。


### 三、阶段 3：客户端验证并生成密钥（Client Key Exchange + 证书验证 + 预主密钥计算 + 主密钥生成）
客户端收到服务器消息后，执行以下关键步骤：
简化流程：
> 对服务器的身份验证（基于CA证书）  
> 对服务器的临时 ECDHE 公钥 验证是否可信（基于证书中的公钥解密得到的哈希值，并且哈希一致）  
> 生成客户端临时 ECDHE 密钥对  
> 发送“Client Key Exchange”消息  
> 计算“预主密钥 Pre-Master Secret”（基于 客户端临时 ECDHE 私钥、服务端临时 ECDHE 公钥 这2项生成；这两对临时的密钥 是与会话绑定的）  
> 生成“主密钥 Master Secket”（基于 Pre-Master Secket、Client Random、Server Random 这三项生成）  
> 生成“会话密钥”，包含对称加密密钥、哈希认证码两部分  
> 发送“Change Cipher Spec”消息  
> 发送“Finished”消息  

**1. 验证服务器证书**  
* 客户端用内置的 CA 根证书（公钥）解密证书中的数字签名，得到哈希值。
* 客户端对证书内容（域名、服务器公钥等）重新计算哈希，对比两者是否一致：
    * 若一致：**证书有效，服务器身份可信**。
    * 若不一致：证书被篡改或伪造，握手终止，浏览器提示风险。
    
**2. 验证服务器密钥交换消息的签名**  
* 客户端用服务器证书中的公钥（如 RSA 公钥）解密 “Server Key Exchange” 中的数字签名，得到哈希值。
* 客户端对服务器临时 ECDHE 公钥、Client Random、Server Random 重新计算哈希，对比是否一致：
    * 若一致：**服务器的临时 ECDHE 公钥未被篡改，可安全使用**。
    * 若不一致：握手终止。

**3. 生成客户端临时 ECDHE 密钥对并发送公钥**  
* 客户端*基于服务器选定的椭圆曲线*（如 x25519），生成自己的**临时 ECDHE 密钥对（私钥仅客户端保存，公钥对外发送）**。
* 发送**Client Key Exchange消息：包含客户端的临时 ECDHE 公钥**。

**4. 计算预主密钥（Pre-Master Secret）**  
**客户端用自己的临时 ECDHE 私钥**，与**服务器的临时 ECDHE 公钥**，通过椭圆曲线 Diffie-Hellman 算法计算出**预主密钥**（*一个随机值，客户端和服务器计算结果完全相同*）。

**5. 生成主密钥（Master Secret）**  
客户端基于以下三个参数，通过 PRF（伪随机函数）生成主密钥：
* 预主密钥（Pre-Master Secret）。
* 客户端随机数（Client Random）。
* 服务器随机数（Server Random）。  
<code>（PRF 公式：Master Secret = PRF(**Pre-Master Secret**, "master secret", **Client Random + Server Random**)）</code>

**6. 生成会话密钥**  
主密钥进一步通过 PRF 生成用于实际加密通信的**会话密钥**，包括：
* **对称加密密钥**（如 AES-GCM 的密钥）。
* **消息认证码（MAC）密钥**（用于验证数据完整性，TLS 1.2 中 GCM 模式已集成完整性校验，此步骤可简化）。

**7. 发送 Change Cipher Spec**   
客户端通知服务器：“后续所有消息将用新生成的会话密钥加密”。

**8. 发送 Finished 消息**  
客户端**用会话密钥加密**一个**哈希值（基于握手过程中所有消息的摘要）**，发送给服务器，用于验证双方是否生成了相同的会话密钥：  
<code>哈希值计算：PRF(Master Secret, "client finished", Hash(所有握手消息))</code>。

### 四、阶段 4：服务器生成密钥并确认握手完成（主密钥生成 + 验证客户端 Finished + 发送 Finished）
服务器收到客户端消息后，执行以下步骤：

**1. 计算预主密钥（Pre-Master Secret）**   
服务器用自己的临时 ECDHE 私钥，与客户端的临时 ECDHE 公钥，通过同样的椭圆曲线 Diffie-Hellman 算法计算出**预主密钥**（与客户端结果完全相同）。

**2. 生成主密钥（Master Secret）**  
服务器用与客户端相同的参数（预主密钥、Client Random、Server Random）和 PRF，生成与客户端完全相同的**主密钥**。

**3. 生成会话密钥**  
服务器基于主密钥生成与客户端相同的会话密钥（对称加密密钥、MAC 密钥等）。

**4. 验证客户端的 Finished 消息**  
* 服务器用会话密钥解密客户端的 Finished 消息，得到哈希值，与自己计算的 “所有握手消息摘要” 对比：
    * 若一致：客户端已正确生成会话密钥，双方密钥同步成功。
    * 若不一致：密钥生成失败，握手终止。

**5. 发送 Change Cipher Spec**  
服务器通知客户端：“我也将用会话密钥加密后续消息”。

**6. 发送 Finished 消息**  
服务器用会话密钥加密一个哈希值（基于握手过程中所有消息的摘要）发送给客户端，格式为：   
<code>PRF(Master Secret, "server finished", Hash(所有握手消息))</code>

**7. 客户端验证服务器的 Finished 消息**  
客户端解密并验证服务器的 Finished 消息，确认双方密钥一致后，握手成功。


## TLS 1.3版本
