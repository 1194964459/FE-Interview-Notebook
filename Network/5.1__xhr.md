# XMLHttpRequest（xhr）
浏览器原生 API，用于与服务器进行异步通信。

```js
const xhr = new XMLHttpRequest();
    
xhr.open("GET", url, false); // 第三个字段：true（异步）、false（同步）
xhr.setRequestHeader("Content-Type", "application/json");
xhr.onreadystatechange = function () {
    if (xhr.readyState !== 4) return;
    if (xhr.status === 200 || xhr.status === 304) {
        // 
    } else {
        // 
    }
};

xhr.send();
```

每当 readyState 改变时，就会触发 onreadystatechange 事件。

## 核心属性
状态相关：
* readyState，存储 XMLHttpRequest 的状态。从 0 到 4 发生变化：
    * 0: 请求未初始化
    * 1（OPENED）：open() 已调用，但未调用 send()
    * 2（HEADERS_RECEIVED）：send() 已调用，响应头已接收
    * 3: 请求处理中
    * 4: 请求已完成，且响应已就绪

* status：响应状态码，200: "OK", 404: 未找到页面。只有当 readyState === 4 时有效。

配置相关：
* **withCredentials**：布尔值，**控制跨域请求是否携带 Cookie 和认证信息**（默认 false，即不携带cookie）。需配合服务器的 Access-Control-Allow-Credentials 响应头使用。
* upload：返回 XMLHttpRequestUpload 对象（只读），用于监听上传进度事件（如文件上传时的进度）。

## 核心方法 
* `open(method, url, async, user, password)`：初始化请求。
    * async：是否异步（true 异步，false 同步）
* `send(body)`：发送请求，必须在 open() 之后调用。
* `setRequestHeader(header, value)`：send() 之前调用，设置请求头。
* `abort()`：中止当前请求

## 常用事件
事件及触发时机如下：
* onreadystatechange：readyState 变化时触发
* onload：请求成功完成
* onloadstart：请求开始发送时（send() 调用后）
* onloadend：请求完成（无论成功/失败/超时/中止）
* 错误(onerror)、超时(ontimeout)、终止(onabort)

### 进度事件特殊说明：
* 上传进度：通过 `xhr.upload.onprogress` 监听（仅适用于 **POST/PUT 等带请求体**的方法）。
* 下载进度：直接通过 `xhr.onprogress` 监听。
```js
// 下载进度
xhr.onprogress = (e) => {
  if (e.lengthComputable) { // 支持计算进度（响应头有 Content-Length 时）
    const progress = (e.loaded / e.total) * 100;
    console.log(`下载进度：${progress.toFixed(1)}%`);
  }
};

// 上传进度（如文件上传）
xhr.upload.onprogress = (e) => {
  if (e.lengthComputable) {
    const progress = (e.loaded / e.total) * 100;
    console.log(`上传进度：${progress.toFixed(1)}%`);
  }
};
```

完整使用示例：
```js
// 创建 XHR 对象
const xhr = new XMLHttpRequest();

// 初始化请求（异步 GET 请求）
xhr.open('GET', 'https://api.example.com/data', true);

// 配置请求
xhr.timeout = 5000; // 超时 5 秒
xhr.responseType = 'json'; // 期望响应为 JSON
xhr.withCredentials = true; // 跨域携带 Cookie

// 设置请求头
xhr.setRequestHeader('Accept', 'application/json');

// 监听事件
xhr.onload = function() {
  if (xhr.status >= 200 && xhr.status < 300) {
    // 成功处理（response 已自动解析为 JSON）
    console.log('响应数据：', xhr.response);
  } else {
    // HTTP 错误（如 404、500）
    console.error('请求失败：', xhr.status, xhr.statusText);
  }
};

xhr.onerror = function() {
  console.error('网络错误（如断网、跨域被拦截）');
};

xhr.ontimeout = function() {
  console.error('请求超时');
};

xhr.onabort = function() {
  console.log('请求已被中止');
};

xhr.onprogress = function(e) {
  if (e.lengthComputable) {
    console.log(`下载中：${(e.loaded / e.total) * 100}%`);
  }
};

xhr.onloadend = function() {
  console.log('请求结束（无论成功/失败）');
};

// 发送请求（GET 方法无请求体，传 null）
xhr.send(null);

// 如需中止请求，可在合适时机调用
// xhr.abort();
```