# Nginx 基本介绍

Nginx反向代理配置如下：

```js
server {
    listen 80;
    server_name example.com;  # Nginx定义的虚拟主机：反向代理时 该值需与客户端页面的域名（与客户端同源）一致

    # 代理客户端对后端接口的请求
    location /api/ {  # 客户端请求路径：http://example.com/api/xxx
        proxy_pass http://api.backend.com:3000/;  # 转发到后端接口：http://api.backend.com:3000/xxx
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 静态资源服务（客户端页面）
    location / {
        root /path/to/frontend;  # 客户端页面的静态文件目录
        index index.html;
    }
}
```
## 一、server 块：定义虚拟主机
server 块是 Nginx 中用于配置虚拟主机的基本单元，**每个 server 块对应一个或多个域名**（通过 server_name 定义），负责处理、匹配这些域名的请求。
```js
server {
    listen 80;                 # 监听端口
    server_name example.com;   # 绑定的域名
    # ... 其他配置 ...
}
```
作用：告诉 Nginx“当收到针对 example.com:80 的请求时，用这个 server 块的规则处理”。


### server_name字段的含义
在 Nginx 配置中，server_name 用于**定义当前虚拟主机（server块）对应的域名 / 主机名**。当客户端发送 HTTP 请求到 Nginx 时，*Nginx 会根据请求头中的 Host 字段（即客户端请求的域名）与配置中的 server_name 进行匹配，从而决定由哪个 server 块处理该请求。*

简单来说，server_name 是 Nginx 识别 “这个请求该由我处理” 的 “身份标识”。

server_name值有两种可能值：
1. **当 Nginx 作为前端代理时：**  
server_name 应与前端域名一致，用于解决跨域问题，此方法*可隐藏后端细节*。
（如前端域名为 frontend.com，Nginx 配置 server_name frontend.com）

2. **当 Nginx 作为后端服务器的入口时：**  
server_name 应与后端域名一致，用于*直接暴露后端服务*。
（如后端域名为 api.backend.com，Nginx 配置 server_name api.backend.com）

## 二、location /：匹配所有路径的请求
location 块用于**定义特定路径的请求处理规则**，而 location / 中的 / 表示 “匹配所有路径”（因为 / 是 URL 的根路径，所有请求路径都以 / 开头）。  
例如：
```js
location / {
    root /var/www/html;        # 静态文件目录
    index index.html;          # 默认首页
}
```
作用：告诉 Nginx“当请求的路径是 /、/about、/api/data 等任意路径时，用这个 location 块的规则处理”。

**location / 优先级低于更具体的 location 规则**，如 location /api。当两个同时命中时，会优先匹配 /api 路径的请求。

### location / 的常用配置场景
**1. 静态网站托管（最常见）** 

用于直接返回静态文件（HTML、CSS、JS、图片等），是搭建静态网站的核心配置。
```js
server {
    listen 80;
    server_name example.com;

    location / {
        root /var/www/example.com;  # 静态文件存放目录
        index index.html index.htm; # 默认首页文件
        try_files $uri $uri/ /index.html;  # 单页应用路由支持（如Vue/React）
    }
}
```
访问 example.com 时返回 /var/www/example.com/index.html。

**2. 性能优化**

location / 作为通用规则，若处理大量请求（如静态文件），可添加缓存、压缩等优化：

```js
location / {
    root /var/www/html;
    expires 1d;  # 缓存1天
    gzip on;     # 启用Gzip压缩
}
```

## 三、单层代理、多层代理
在反向代理或负载均衡环境中，客户端请求会先到达代理服务器，再由代理服务器转发给后端服务器。此时，后端服务器的日志中记录的 IP 地址是**代理服务器的 IP**，而非客户端的真实 IP。为了让后端服务器知道客户端的真实 IP，需要通过请求头传递这些信息。

**X-Real-IP：** 
* 记录客户端的真实 IP 地址
    > 注意：多层代理时，该值有可能并不是客户端的IP，而是代理的IP，具体参考下面的“多层代理场景”
* 通常只包含一个 IP 地址。

**X-Forwarded-For (XFF)：** 
* 记录客户端 IP 及请求经过的每个代理服务器的 IP。
* 多个 IP 地址，用逗号分隔，客户端 IP 在最左侧。

### 1. 单层代理场景
```js
客户端(192.0.2.1) → Nginx代理(10.0.0.1) → 后端服务器
```
Nginx配置如下：
```js
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

后端服务器收到的请求头：
```js
X-Real-IP: 192.0.2.1
X-Forwarded-For: 192.0.2.1
```

### 2. 多层代理场景
```js
客户端(192.0.2.1) → CDN(203.0.113.1) → Nginx(10.0.0.1) → 后端服务器
```

* CDN添加的请求头：
```js
X-Forwarded-For: 192.0.2.1
```

* Nginx 添加的请求头：
```js
proxy_set_header X-Real-IP $remote_addr;  # CDN的IP: 203.0.113.1
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 追加当前代理IP
```

* 后端服务器收到的请求头：
```js
X-Real-IP: 203.0.113.1
X-Forwarded-For: 192.0.2.1, 203.0.113.1
```
为什么？
> $remote_addr → 203.0.113.1（CDN 的 IP）<br/>
> $proxy_add_x_forwarded_for 的含义：
“当前收到的 X-Forwarded-For 值” + “, + $remote_addr”。
收到的值是 192.0.2.1，于是：
X-Forwarded-For: 192.0.2.1, 203.0.113.1




**后端服务器获取真实 IP 的方式：**
* 从 X-Forwarded-For 中取第一个 IP（最左侧）
* 或从 X-Real-IP 中获取（但此时得到的是 CDN 的 IP，而非客户端真实 IP）

## 四、高级配置示例
### 1. 负载均衡配置
```js
http {
    # 定义上游服务器组
    upstream backend_servers {
        server backend1.example.com weight=5;  # 权重为5
        server backend2.example.com weight=3;  # 权重为3
        server backend3.example.com backup;    # 备份服务器
    }
    
    server {
        listen 80;
        server_name example.com;
        
        location / {
            proxy_pass http://backend_servers;  # 使用上游服务器组
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
```

### 2. 缓存配置
```js
http {
    # 定义缓存区域
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g;
    
    server {
        listen 80;
        server_name example.com;
        
        location /static/ {
            proxy_pass http://backend;
            proxy_cache my_cache;  # 使用缓存区域
            proxy_cache_valid 200 302 10m;  # 200和302状态码缓存10分钟
            proxy_cache_valid 404 1m;       # 404状态码缓存1分钟
        }
    }
}
```

### 3.HTTPS 代理配置
```js
server {
    listen 443 ssl;
    server_name example.com;
    
    # SSL证书配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto https;  # 传递协议信息
    }
}
```