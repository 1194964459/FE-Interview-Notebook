# 生命周期

参考：

[Vue2 与 Vue3 生命周期对比](https://www.doubao.com/thread/w516e5d809adbeaa5)

[选项式、组合式API](./0.0__选项式API与组合式API.md)


## 一、vue2 与 vue3 生命周期对比
Vue3 中 “销毁” 相关钩子统一改为 “卸载”（Unmount），更符合实际语义；

| Vue2 生命周期钩子| 	Vue3 生命周期钩子（选项式 API）| 说明| 
| ---- |---- |---- |
| beforeCreate| 	beforeCreate| 	在**组件实例初始化完成**并且 **props 被解析后**立即调用。| 
| created	| created| 	在组件实例**处理完所有与状态相关的选项后**调用。（在这个钩子被调用时，*响应式数据、计算属性、方法和侦听器 已经设置完成*）| 
| beforeMount| 	beforeMount| 	组件挂载前调用| 
| mounted	| mounted	| 组件挂载完成后调用| 
| beforeUpdate| 	beforeUpdate| 	组件更新前调用| 
| updated| 	updated| 	组件更新完成后调用| 
| beforeDestroy| 	**beforeUnmount**| 	重命名，组件卸载前调用（语义更清晰）| 
| destroyed	| **unmounted**	| 重命名，组件卸载完成后调用（语义更清晰）| 

疑问点❓：
1. beforeCreate钩子的执行时机“**组件实例初始化完成**且 **props 被解析后**执行”具体是什么意思？    
    * “props 被解析”指的是：当父组件向子组件传递 props 时，子组件并非直接 “原封不动” 接收这些值，而是要经过 Vue 的解析流程，确保 props 符合子组件的声明规则。主要有：类型与规则校验、默认值处理、格式转换等。
    * 组件实例初始化完成：组件实例刚创建（只有空壳），data、methods 均未初始化，还访问不到。
2. create钩子的执行时机：在组件实例**处理完所有与状态相关的选项后**调用，在这个钩子被调用时，data已转为响应式数据、methods绑到实例上、方法、侦听器都设置完成。此时props、data、methods都可以访问了，不过还没绑定到DOM上，所以$el 访问不了。在这个钩子中，经常会做的事情：
    * 执行一些**数据初始化操作**：设置默认值，或者根据 props 的值来初始化组件内部的数据状态。
    * **异步数据获取**：在 DOM 渲染之前获取数据，避免出现空白、闪烁！

3. mounted钩子：在组件的模板已经挂载到真实 DOM 后调用。可以 通过 this.$el 访问到每个组件实例的根 DOM 元素，并且可以对 DOM 进行各种操作，比如添加事件监听器、获取 DOM 的尺寸和位置等。在这个钩子中，经常会做的事情：
    * DOM操作：获取和操作DOM元素（this.$el 或 this.$refs）、初始化第三方插件（如基于 DOM 的图表 echarts等）
    * **事件绑定**

4. vue中，推荐在哪个生命周期发起请求？
    * **绝大多数场景**，优先在 created（选项式）或 setup（组合式）中发起请求，尽早加载数据。
        * created钩子中已经可以拿到propd、data，然后setup 函数在 created 之前执行。这两个时机发起请求，可以让**数据加载与 DOM 渲染并行进行**，减少用户看到内容的总耗时
        * *大多数请求不依赖 DOM，通常只需要props或组件内部状态*。因此完全可以在 DOM 渲染前发起，无需等待 mounted后
    * **依赖 DOM 的特殊场景**，在 mounted 中发起请求。

## 二、vue3中选项式、组合式生命周期对比
| 组合式 API 生命周期函数| 	对应选项式 API 钩子| 	说明| 
| ---- |---- |---- |
| onBeforeMount| 	beforeMount| 	组件挂载前调用| 
| onMounted| 	mounted	| 组件挂载完成后调用| 
| onBeforeUpdate| 	beforeUpdate| 	组件更新前调用| 
| onUpdated	| updated	| 组件更新完成后调用| 
| onBeforeUnmount| 	beforeUnmount| 	组件卸载前调用| 
| onUnmounted| 	unmounted| 	组件卸载完成后调用| 
| onActivated | activated |适用于`<KeepAlive>`组件，组件**激活**后调用 |
| onDeactivated | deactivated |适用于`<KeepAlive>`组件，组件**失活**后调用 |
| **onRenderTracked**	| -	| Vue3 新增，用于调试：跟踪虚拟 DOM 渲染时的依赖| 
| **onRenderTriggered**	| -	| Vue3 新增，用于调试：触发虚拟 DOM 重新渲染时调用| 

组合式 API 中没有```beforeCreate```和```created```两个生命周期钩子

## 三、setup 详解
* setup是组合式API的入口，组合式 API 的生命周期函数必须在setup中调用，如：Provide/Inject、defineEmits、ref等...  
* setup函数的执行时机是：组件实例创建前执行（beforeCreate 钩子之前），此时组件实例尚未初始化。因此setup 中不能使用 this 且 setup只执行一次。
    > beforeCreate 钩子 是在组件实例初始化完成后执行
* setup 相当于是干了```beforeCreate```和```created```两个生命周期钩子干的事。如：初始化组件的响应式数据、定义方法、注册生命周期钩子、处理 props 和事件等
* setup()通常只在两种情况下使用：
    * 非单文件组件中使用组合式API
    * 基于选项式API的组件中 使用 组合式API代码。
    
    除此以外，都优先使用```<script setup>```

## 四、生命周期流程图
参考：![生命周期图谱](./icon/lifecycle.png)
