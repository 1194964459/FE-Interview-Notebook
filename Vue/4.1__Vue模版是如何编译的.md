# Vue 模版是如何编译的？
Vue 模板编译是将**模板字符串**转换为**可执行的渲染函数**的过程。具体流程如下：
```
模板字符串 → 解析器 → AST → 优化器 → 优化后的AST → 代码生成器 → 渲染函数
```
实际应用中，Vue 会**根据环境决定编译时机**：**开发环境**通常**在浏览器中即时编译**（runtime + compiler 版本），**生产环境**推荐使用**预编译（仅需 runtime 版本）**，通过 vue-loader 等工具在构建时完成编译

## 一、编译过程主要分为三个阶段：

**1. 解析阶段（Parsing）：将模板字符串解析成抽象语法树（AST）**
* *HTML 结构解析*：标签、属性、文本、嵌套关系等；
* Vue 语法解析：识别指令（如 v-if、v-for）和插值表达式（如 `{{}}`）
* 同时进行**语法检查**，确保模板格式正确

**2. 优化阶段（Optimization）：对 AST 进行静态节点标记**，静态节点是指那些不依赖数据变化的节点（如纯文本）  
* 遍历 AST，标记出静态节点（static: true）和静态根节点（staticRoot: true）。
* 标记后，在后续更新中可以跳过这些节点的比对和渲染。
    > 首次渲染后**静态节点会被缓存**，后续不需要创建 直接复用即可

**3. 生成阶段（Code Generation）：将优化后的 AST 转换为渲染函数**，渲染函数是一个返回虚拟 DOM 树的 JS 函数。


## 二、优化阶段是如何对AST进行静态节点标记的？
主要是标记静态节点、静态根节点...

### 1. 标记静态节点
何为静态节点？不依赖任何响应式数据，渲染结果永远不会变化的节点。

怎么标记？为节点添加 `static: true` 或 `static: false` 属性。

判断规则：
* **文本节点**：（纯文本，不含**插值表达式**）是静态节点
* **元素节点**：没有插值`{{ }}`、指令`v-if/v-for`和动态绑定`:class/@click`，不是自定义组件、没有slot或template等标签，并且所有属性都是静态的

### 2. 标记静态根节点
静态根节点是啥？本身是静态节点，且至少有一个静态子节点（非文本节点）的节点。
怎么标记：为节点添加 `staticRoot: true` 属性。


## 三、静态树提升（Hoist Static Trees）
将静态根节点的渲染逻辑从渲染函数中「提升」出来，作为常量缓存（如 _hoisted_1）。每次执行渲染函数时，直接复用这些缓存的虚拟 DOM 节点，无需重新创建。

示例：
```js
// 优化前的渲染函数（简化）
function render() {
  return h('div', [
    h('h1', '静态标题'), // 静态节点，每次渲染都会重新创建
    h('p', this.message)
  ])
}

// 优化后的渲染函数
const _hoisted_1 = h('h1', '静态标题') // 静态节点被提升为常量
function render() {
  return h('div', [
    _hoisted_1, // 直接复用缓存
    h('p', this.message)
  ])
}
```
