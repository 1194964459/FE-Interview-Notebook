# 亚运项目回顾
参考：
【有道云笔记】亚运难点
https://share.note.youdao.com/s/H95KKOf

杭州亚运项目流程梳理：https://share.note.youdao.com/s/KREpPQRn

杭州亚运“支付宝侧问题”统计：https://share.note.youdao.com/s/SZIi5QvU

高德地图JS API
https://lbs.amap.com/api/javascript-api-v2/getting-started

## 最新版简历
* 了解Three.js，并有简单的Demo应用；


## 我的职责
https://mr.sensetime.com/sense-magic/

基于webAR SDK做前端AR开发，这个webARSDK会暴漏一些方法、事件给我们，通过调用这些来获取AR能力。

除了底层SLAM算法、3D渲染相关的，其余都我们来做的。出了问题后也是我们前端团队先来排查、定位问题。
如果是算法相关的就找算法同学，自己能修改的渲染、接口问题 就自己来，搞不了的 请教一下渲染同学。界面UI、业务逻辑啥的都是前端实现的。


* 业务的开发：
* 定位权限的获取
* 辅助排查定位的准确性，具体辅助手段有...
* 辅助排查导航路径的连通性
* 如何和SDK交互?
* 通过这些学到了什么？提升是什么？还有什么迷惑的点..

```js
    const { subscribe } = AREngine

    subscribe(stxr.PoiPullFailureEventArgs.ClassType, this.OnPoiPullFailure, this)
    subscribe(cityar.InitResourceDoneEventArgs.ClassType, this.OnInitResourceDone, this)
    subscribe(cityar.InitResourceFailureEventArgs.ClassType, this.OnInitResourceFailure, this)
    subscribe(cityar.InitResourceStartEventArgs.ClassType, this.OnInitResourceStart, this)
    subscribe(cityar.InitResourceUpdateEventArgs.ClassType, this.OnInitResourceUpdate, this)
    subscribe(cityar.NavigationArriveEventArgs.ClassType, this.OnNavigationArrive, this)
    subscribe(cityar.NavigationUpdateEventArgs.ClassType, this.OnNavigationUpdate, this)

// 
cityar.NavigationOffCourseEventArgs
stxr.LocateRequestingFailureEventArgs
stxr.LocateRequestFailureEventArgs
stxr.LocateRequestSuccessEventArgs
```

首次定位逻辑： 首次定位 slam 开关关掉。下面几种情况使用首次定位逻辑：
* 跨楼层暂停后重新开始、从后台切前台、连续3次失败后

导航过程中的：静默定位校准
* IOS手机，比较最近两次定位成功的时间间隔，若超过20s，则2s后发送一次定位请求；
* 安卓机，比较最近两次定位成功的时间间隔，若超过7.5s，则 3.8s后发送一次定位请求

跨楼层导航：跨楼层时，到新的楼层要清除 3s 前的蓝牙数据
偏航

资源加载：

定位成功后声音提示用户
AR模型展示时，很多音频，

## 疑问？
小程序中如何使用Window对象？ 参考上面的“杭州亚运项目流程梳理”

## 小程序中是如何展示出AR模型的？
TODO:

## 业务功能
判断是否在体验区，不在的话需反馈给用户..

场馆搜索、切换

首次时的引导提示、

AR定位前的帮助提示、定位中/定位成功/失败的反馈提示；
发起导航：若终点不可达、路线规划失败等给予用户反馈；

跨场馆、跨楼层导航：
![跨场馆导航](./icon/跨场馆导航.jpg)

1px的问题如何解决？
rpx（responsive pixel）可以根据屏幕宽度进行自适应，规定屏幕宽为 750rpx。
rpx 自动转换成 px 或 rem


## 页面中的动画：
* 加载页：起初雪碧图实现，后来改为视频..
    > 要求的效果：全屏加载，三种不同的背景色、配合三个不同的吉祥物 用不同的欢迎手势..
* 定位中的提示，提示手机左右移动
* 定位成功：
    > background-image设置雪碧图，然后通过修改 background-position修改雪碧图位置，可以用 transform: translate() 替代，性能更优
* 导航成功后，启用倒计时属性文案并修改opacity
* 跨楼层到达电梯时，倒计时..
* 静默校准时，动态调整显示文案的scale、opacity
* 信息面板高度动态调整，且有时长限制：

    ```js

    .ani-1 {
    transition: all cubic-bezier(0.22, 0.61, 0.36, 1) 0.1s;
    }

    .ani-init {
    transition: all cubic-bezier(0.22, 0.61, 0.36, 1) 0.5s;
    }

    .height-0 {
    height: 0;
    }

    /* 设计稿高度统一为812 */
    .height-1 {
    height: 71.55vh;
    }

    .height-2 {
    height: 78.94vh; 
    }
    ```

## 了解 Three.js

## 项目中的重点、难点
### 1. 一个页面，但是逻辑及变量的状态超级多...

静默定位状态，目前共4种：autoLocate-init, autoLocate-ing, autoLocate-success, autoLocate-failed

定位结果，目前共5种：locate-init、locate-first、locate-ing, locate-success,locate-fail, locate-limit(缺失IMU数据/相机数据等)

搜索时的status共有[unSearch, isSearching, searchFailed, noResult, searchSuccess]几种状态

导航状态，目前共5种：nav-init, nav-ongoing, nav-arrived, nav-elevator, nav-pause, nav-unavailable

### 与支付宝对接中的问题
AR运行效果，与这4种因素紧密联系：
* 手机类别（安卓、ios）、
* 不同的手机厂商（华为、小米、oppo...）、
* 不同厂商的不同型号的手机、
* 支付宝的不同版本

支付宝每次升级时，我们的提心吊胆的。因为它会出现各种各样的问题：
* 可能会导致卡，有的甚至都不能用了，尤其是安卓机；
* 使用过程中，发热、掉帧很严重；
* 线上图片不能展示，提示403
    > 支付宝的Refer策略变了
* 音频播放不了
* 渲染出问题了，摄像头置灰
* ARSession创建失败：原因是支付宝侧AR实例管理不够精细导致的。
* 华为手机获取不到加速度计数据...
* AR文件无法加载：支付宝wasm文件写入报错！
* android相册存储授权之后，相机卡死的

## 注意事项：
gps 要预热的，不然获取的不太准、或者 获取不到。。
有的手机蓝牙数据不更新


## 简历修改：
传统的GPS导航一般只适用于室外，在室内导航效果一般。而AR导航是将虚拟箭头和指示叠加在真实的现实世界中，使导航过程更直观、定位更精准，在室内、室外都很适用。依托视觉算法团队的 WebAR SDK 实现基本 AR 效果，AR导航会基于GPS、蓝牙、IMU、视觉、SLAM等多端融合技术来定位，定位成功后发起至目的地的导航，然后在导航过程中持续进行静默定位校准，避免偏航。



项目背景：
通过AI+AR技术与亚运赛事结合，为杭州亚运带来诸多虚实融合的互动体验。传统的GPS导航一般只适用于室外，室内导航效果一般。AR导航会基于GPS、蓝牙、IMU、视觉、SLAM等多端融合技术来定位，定位成功后发起至目的地的导航，导航过程更直观、定位更精准。

主要贡献：
* 从零到一支持项目的开发上线即后续所有版本迭代、UI改版；
* 支持中、英文双语版；正式、测试环境隔离；安卓、iOS 两种机型多支付宝版本适配；
* 支持安卓、iOS 手机的 GPS、蓝牙、相机权限申请与校验等；权限通过后，获取多端融合定位技术中需要的数据；
* 支持资源加载、搜索、看台布局相关功能开发，可点击、拖拽、高亮显示看台布局；
* 支持奥体、黄龙2 个园区，6 个场馆的导航功能；支持“观亚运”中首页、知识科普功能，可点击3D物体来展示具体运动的科普内容；
* 定位：实现定位预检测/定位中/定位成功/定位失败/相机或IMU数据缺失等多个模块的JS逻辑、UI实现；
* 导航：实现导航中/导航到达/导航不可达/跨楼层、跨场馆导航逻辑，支持导航过程中静默定位校准逻辑；
* 为给用户更鲜明的反馈，定位、导航中很多状态实现是动画实现的，并有声音、震动等提示。  
* 为更好的排查定位与导航问题，自研多个测试小工具。1. GPS、蓝牙数据采集工具；2.“支付宝”版可视化面板：基于 Canvas 对导航起点/终点/路径/定位结果等进行可视化展示；3.“网页版”版：根据图片获取纯视觉定位结果、基于高德地图API圈定场馆/园区范围 查看某GPS值所属范围、排查可能因POI点位/蜂鸟图商路径/定位不准等带来的路径不通问题。


![云端定位算法](./icon/云端定位算法.png)