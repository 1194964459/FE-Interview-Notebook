# 大文件上传
文件上传、取消


大文件分片上传：前端将一个体积庞大的文件拆分成多个小片段，通过并发请求分别上传，最后在服务器端重新合并成完整文件。


[除了分片上传，还有哪些常见的大规模数据上传优化方法？](https://www.doubao.com/thread/w70774dab4285d922)

## 相关知识点了解：
* 预签名Url：
    * 使用预签名 URL允许他人将特定对象上传到您的 Amazon S3 存储桶。这允许在不要求另一方拥有 AWS 安全凭证或权限的情况下进行上传。
    * 预签名Url有过期时间

* 文件状态：排队中、上传中、上传成功、上传失败、已取消、上传中断   
    > 上传中断与取消的区别：中断是网络等问题被意外终止的；取消是用户主动操作的  TODO:
    > 项目中是如何标记“上传中断”的？前端的状态，后端仍旧将其归为“上传中”
```js 
item.status === upload.FILE_STATUS.UPLOAD && !upload.isUploading(item)

isUploading(item: UploadItem) {
    const it = this.uploaders.find(
        (up) => up.item?.resourceId === item.resourceId
    );
    return !!it;
}
```

* 动作：取消上传、重新上传（失败的、取消的）


小文件(小于分片大小)直接上传
* 支持上传进度获取
* 取消
* 正常、错误展示

大文件分片上传
预签名url获取（批量），会返回uploadId
调用预签名url上传
获取分片上传进度
完成分片上传
取消分片上传

批量获取preSignedUrl（预签名url）

2. 
断点续传  TODO:




主要负责的是：资源重建
![琼宇资源文件上传分类](./icon/琼宇资源文件上传分类.jpg)

本质是围绕：把什么样的资源文件（RESOURCE_TYPE） 上传 到哪（OSS_TYPE）?
建图所需的数据，无人机、rgb等采集工具采集的数据 上传到
`RESOURCE_TYPE.RT_RECONSTRUCTION ---> OSS_TYPE.AUTO`

纹理编辑：`RESOURCE_TYPE.RT_TEXTUREEDIT ---> OSS_TYPE.AUTO`

重建结果的模型数据：
`RESOURCE_TYPE.RT_MODELASSET ---> OSS_TYPE.AUTO`




## Upload Manage 模块：
```
<!-- 变量 -->
uploadList(响应式的)

RESOURCE_TYPE

OSS_TYPE：
    默认是 AUTO
    AOSS（商汤大装置兼容aws s3）、
    其他几种(阿里云对象存储 ALIOSS、MINIO、微软AZURE)

FILE_STATUS：INIT、上传中、上传成功、失败...

队列相关的：queueVector（reactive类型）、currentQueueId（ref类型）

<!-- 方法 -->
findQueueItem、updateQueueName
duplicate()
addFiles()
startUpload()
restartItems()：针对“上传失败”的，全部重试；
startItem()：“上传中断”的重传，仅仅是针对单个的；除此之外和restartItems是一样的
clear()

<!-- 事件 -->
on、off 等事件方法

事件类型：UPLOAD_EVENT，如ASSET_STATUS_CHANGE

upload.on(upload.UPLOAD_EVENT.ASSET_STATUS_CHANGE, onItemStatusChange);
```

## Upload 模块
资源上传成功后，更新status;

若是上传失败、取消，则批量删除，然后设置其resourceId = ''

```js
createResource(items：UploadItem[])
初始化资源、模型，获取resourceId、resourceUrl等

start(item: UploadItem) 调用相应的client的upload()进行上传

stop()  停止、取消上传，需调用对应的Client

setStatus()

<!-- 事件 -->
this.onUploadInit 
this.onUploadProgress 
this.onUploadFinish
this.onUploadError 
```

```js
// 只有AOSS有uploadId字段，其他像
case OSSType.AOSS:
    await assetsApi.v1AssetsAssetIdResourcesResourceIdPut(
        this.ownerId, 
        this.resourceId,
        { status: value, uploadId: this.uploadId }
    );
```

## 
```js
input(ref="filePicker" hidden multiple @change="handleBatchUploadFile" :accept="SUPPORT_FILE.suffixSet" type="file")
input(ref="folderPicker" hidden webkitdirectory multiple directory @change="hanleUploadFolder" type="file")
```