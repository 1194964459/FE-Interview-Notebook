# 基于 Yapi 自动生成API请求代码

技术背景

技术选型

技术实现
    1. 步骤1 
    2. 步骤2


拦截器、TODO: 如何实现？拦截这些主要做什么呢？
requestInterceptors

npm包：axios、请求参数处理（浏览器原生URLSearchParams：简单请求，qs：复杂场景）
put、post请求的区别

[axios](https://www.javasoho.com/axios/#%E7%89%B9%E6%80%A7)


## 没封装前是怎样的？
首先，定义一个API请求相关的client，里面定义了不同的请求方法(如get、post等)，还有相关的拦截器
```js
const defaultConfig: AxiosRequestConfig = {
  baseURL: '/',
  timeout: 60000,
  headers: {
    Accept: 'application/json',
  },
}

export class ApiClient {
    private instance: AxiosInstance
    constructor(baseURL = '/') {
        this.instance = axios.create({ ...defaultConfig, baseURL })
        // 只是作为一个例子展示，具体的拦截器根据场景去实现。
        this.instance.interceptors.request.use(
            tokenInterceptor,
            requestError
        )
        this.instance.interceptors.response.use(responseSuccess, responseError)
    }
    get(){
        return this.instance.request({
            method: 'GET',
            url,
            params,
            ...config,
        })
    }
    // post请求
    // detele..

}

export const BASE_URL = '/'
export default new ApiClient(BASE_URL)
```
其次，在每个项目中定义该项目相关的 BaseUrl、公共路径啥的
```js
export const COMMON_DATA = '/api/platform/common-data'
export const withCommon = (path: string) => `${COMMON_DATA}${path}`
export const withAC = (path: string) => `/api/platform/inception-account${path}`

```

最后：定义具体的请求，每个请求都要定义，接口参数定义类型，超级繁琐
```js
import http from '@sense-inception/services/ApiClient'
export const COMMON_DATA = '/api/platform/common-data'
// import { COMMON_DATA } from '.'  // 获取当前目录的入口文件：若没有 package.json 或 main 字段，则按固定文件名 index 查找

export interface BasicInfo {
  mapName: string
  mapImgPath: string
  mapScale: MapScale
}

// 获取园区列表
export const getRegionList = (params: BasicInfo) => {
  return http.get(`${COMMON_DATA}/v1/regions`, params)
}
```

## 如何封装？
@openapitools/openapi-generator-cli，使用这个工具可以大大减少手动编写 API 相关代码的工作量，提高开发效率。

接口是在 YAPI 上管理的，可以按照“分组”、“项目”来管理对应的“接口”。
1. 里面有一个专门的接口，可以获取**某个项目下的所有接口信息**
2. 调用该接口，然后 基于yapiJSon2swagger.cjs脚本，**将 YAPI 的 JSON 数据转换为符合 Swagger/OpenAPI 规范的JSON数据**
    > YAPI中也支持：「OpenAPI (Swagger)」格式 的数据导出。
3. 之前的接口数据是全量的，需要**过滤筛选我们内部需要的接口列表**；
4. 再基于`openapi-generator-cli`，从 **OpenAPI 规范文件**生成**特定编程语言和框架的 API 客户端代码**。我们内部是使用`typescript-axios`，生成基于 TypeScript 语言，并使用 axios 库来进行 HTTP 请求的 API 客户端代码。

5. 生成的代码主要有：api.ts、configuration.ts之类的，


参考：[使用openapi-generator-cli导出的数据？](https://www.doubao.com/thread/wf53d5a69ab486ff6)

```js
import { Configuration, UserApi } from './src/api';

// 初始化配置（设置基础 URL 和认证信息）
const config = new Configuration({
  basePath: 'https://api.example.com/v1',
  apiKey: 'user-token-123'
});

// 创建 API 实例
const userApi = new UserApi(config);

// 调用接口
async function fetchUsers() {
  try {
    const response = await userApi.getUserList(1, 10);
    console.log('用户列表:', response.data);
  } catch (error) {
    console.error('获取用户失败:', error);
  }
}

// 执行
fetchUsers();
```



琼宇 项目中的配置：
```js
const APIS = [
  {
    name: "metaverse-storage",
    url: "http://yapi.inception-diamond.sensetime.com/api/open/plugin/export-full?type=json&pid=327&status=all&token=0c73ac1cdc050ef59927c0228f7786425fa2f5c043b41397597a3fb3e1391665",
    folder: "../../src/services/autogen-storage",
    include: [
      "/service-resource/{serviceName}/{module}/resources/list",
      "/storage/token",
      "/storage/upload/url",
      "/storage/multipart-upload/urls",
      "/storage/multipart-upload/cancel",
      "/storage/multipart-upload/complete",
      "/storage/multipart-upload/parts",
    ],
  },
]
```

Axios配置：
```js
{
  // `url` 是用于请求的服务器 URL
  url: '/user',

  // `baseURL` 将自动加在 `url` 前面
  baseURL: 'https://some-domain.com/api/',
}