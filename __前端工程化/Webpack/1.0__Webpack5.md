# Webpack 5
Webpack 5 于 2020 年 10 月发布，是目前的最新稳定大版本，带来了多项重要改进，包括：

* 内置持久化缓存提升构建性能
* 改进的树摇（Tree Shaking）机制
* 更好的代码分割策略
* 模块联邦（Module Federation）支持
* 优化的输出内容（更简洁的代码）
* 对 Node.js polyfill 的调整（默认不再自动包含）


## 代码分离（Code Splitting）
代码分离可以分出出更小的bundle，以及控制资源加载优先级，之后我们可以**按需加载**，或者并行加载，减少初次加载的 bundle 体积，充分利用浏览器缓存啥的。

> 背景：默认情况下，所有的JavaScript代码（业务代码、第三方依赖、暂时没有用到的模块）在首页全部都加载，就会影响首页的加载速度​。

优势：
* **减小初始加载的 bundle 体积**，提升首屏加载速度
* 实现资源的**并行加载**，提高加载效率
* **利用浏览器缓存**，已加载的代码无需重复下载
* **便于维护和迭代**，不同模块可独立更新

应用场景：
* **代码拆分**：将代码按**路由**维度或者**组件**分块(chunk)，这样做到*按需加载，同时可以充分利用浏览器缓存*​。
* **库分离**：将第三方库（如 React、Lodash）与业务代码分离
* **条件加载**：根据用户交互或环境动态加载代码

### 实现方法：
* 入口起点：配置多入口手动分离代码
```js
// webpack.config.js
module.exports = {
  entry: {
    index: './src/index.js',
    another: './src/another.js'
  },
  output: {
    filename: '[name].bundle.js',
    path: path.resolve(__dirname, 'dist')
  }
}
```
* 动态导入：通过 ES6 的 import() 语法实现按需加载（返回 Promise）
* **SplitChunksPlugin**： Webpack 内置的代码分割插件（Webpack 4+ 已内置，无需额外安装），用于自动提取代码中可共享的部分（如公共模块、第三方库），生成独立的 chunk 文件，避免代码重复打包，优化加载性能。

其默认配置如下：
```js
// webpack.config.js
module.exports = {
  optimization: {
    splitChunks: {
      chunks: 'async',   // 只对异步加载的chunk生效
      
      // 包的体积应该在（minSize, maxSize）之间，体积小于minSize的不会拆，大于maxSize的会被拆
      minSize: 20000,  // 最小体积
      maxSize: xx, // 最大体积，
      
      minChunks: 1, // 被引用次数

      minRemainingSize: 0,
      maxAsyncRequests: 30,  // 异步加载时最大并行请求数
      maxInitialRequests: 30,  // 初始加载时最大并行请求数
      enforceSizeThreshold: 50000,
      cacheGroups: {   // 缓存组：定义不同的拆分规则；该属性内的键值可以自定义！
        defaultVendors: {
          test: /[\\/]node_modules[\\/]/,  // 匹配node_modules中的模块
          priority: -10,  // 优先级（数值越大越优先）
          reuseExistingChunk: true,
        },
        default: {
          minChunks: 2,
          priority: -20,
          reuseExistingChunk: true,  // 复用已存在的chunk
        },
      },
    },
  },
};
```
chunks：指定对哪些类型的 chunk 生效
* async：仅异步 chunk（默认）
* initial：仅初始 chunk
* all：所有类型的 chunk（推荐）