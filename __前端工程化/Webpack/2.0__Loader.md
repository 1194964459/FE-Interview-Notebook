# Loader
å‚è€ƒï¼š

[åŸºäºthis.async()ï¼Œå®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„å¼‚æ­¥ Loader](./code/å®ç°ä¸€ä¸ªè‡ªå®šä¹‰loader/webpack.config.js)

[ç”±æµ…åŠæ·±å®ç°ä¸€ä¸ªè‡ªå®šä¹‰loader](https://juejin.cn/post/6903856764018982925)


Webpack æœ¬èº«åªèƒ½å¤„ç† JavaScript å’Œ JSON æ–‡ä»¶ï¼ŒLoader çš„ä½œç”¨æ˜¯å°†å…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼ˆå¦‚ .cssã€.tsã€.png ç­‰ï¼‰è½¬æ¢ä¸ºæœ‰æ•ˆçš„æ¨¡å—ï¼Œä¾› Webpack è¿›ä¸€æ­¥å¤„ç†æˆ–æ‰“åŒ…ã€‚

**Loader æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°**ï¼Œæ¥æ”¶æºæ–‡ä»¶å†…å®¹ä½œä¸ºå‚æ•°ï¼Œè¿”å›è½¬æ¢åçš„å†…å®¹ï¼ˆæˆ–å¤„ç†åçš„ç»“æœï¼‰ã€‚

## ä¸€ã€åŸºæœ¬ç‰¹æ€§
**1. é“¾å¼è°ƒç”¨**  
å¤šä¸ª Loader å¯ä»¥ä¸²è”ä½¿ç”¨ï¼Œå‰ä¸€ä¸ª Loader çš„è¾“å‡ºä½œä¸ºåä¸€ä¸ª Loader çš„è¾“å…¥ã€‚æŒ‰**ä»å³åˆ°å·¦ï¼ˆæˆ–ä»ä¸‹åˆ°ä¸Šï¼‰ çš„é¡ºåºæ‰§è¡Œ**ã€‚ 

```js
use: ['style-loader', 'css-loader', 'less-loader']
```
æ‰§è¡Œé¡ºåºï¼šless-loaderï¼ˆå°† Less è½¬ CSSï¼‰â†’ css-loaderï¼ˆè§£æ CSS æ¨¡å—ï¼‰â†’ style-loaderï¼ˆå°† CSS æ³¨å…¥ DOMï¼‰ã€‚

**2. æ”¯æŒå¼‚æ­¥æ“ä½œ**   
å¦‚è¯»å–æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ï¼Œå¿…é¡»é€šè¿‡ this.async() å®ç°ã€‚

this.async() ä¼šè¿”å›ä¸€ä¸ª callback å‡½æ•°ï¼Œå½“å¼‚æ­¥æ“ä½œç»“æŸåï¼Œéœ€è°ƒç”¨è¯¥å‡½æ•°é€šçŸ¥ Webpackï¼Œå¹¶ä¼ é€’å¤„ç†ç»“æœã€‚å¦‚ï¼š

```js
// å¼‚æ­¥ Loader ç¤ºä¾‹ï¼šå»¶è¿Ÿå¤„ç†ä»£ç 
module.exports = function(source) {
  // 1. è°ƒç”¨ this.async() è¿›å…¥å¼‚æ­¥æ¨¡å¼ï¼Œè·å–å›è°ƒå‡½æ•°
  const callback = this.async();
  
  // 2. æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼ˆå¦‚å®šæ—¶å™¨ã€æ–‡ä»¶è¯»å–ç­‰ï¼‰
  setTimeout(() => {
    // 3. å¤„ç†æºæ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼šåœ¨ä»£ç å‰æ·»åŠ æ³¨é‡Šï¼‰
    const result = `/* å¼‚æ­¥å¤„ç†åçš„ä»£ç  */\n${source}`;
    
    // 4. è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œé€šçŸ¥ Webpack å¼‚æ­¥æ“ä½œå®Œæˆ
    // ç¬¬ä¸€ä¸ªå‚æ•°ï¼šé”™è¯¯ä¿¡æ¯ï¼ˆnull è¡¨ç¤ºæ— é”™è¯¯ï¼‰
    // åç»­å‚æ•°ï¼šå¤„ç†åçš„ç»“æœï¼ˆå¦‚è½¬æ¢åçš„ä»£ç ã€sourceMap ç­‰ï¼‰
    callback(null, result);
  }, 1000);
};
```
éœ€æ³¨æ„ğŸ“¢ï¼š
* å¿…é¡»è°ƒç”¨å›è°ƒå‡½æ•°ï¼šè°ƒç”¨ this.async() åï¼Œå¿…é¡»åœ¨å¼‚æ­¥æ“ä½œç»“æŸæ—¶æ‰§è¡Œè¿”å›çš„ callbackï¼Œå¦åˆ™ Webpack ä¼šä¸€ç›´ç­‰å¾…ï¼Œå¯¼è‡´æ„å»ºå¡ä½ã€‚
* callback çš„å‚æ•°æ ¼å¼ï¼š
    * errï¼šé”™è¯¯å¯¹è±¡ï¼ˆæ— é”™è¯¯æ—¶ä¼  nullï¼‰
    * contentï¼šå¤„ç†åçš„ä»£ç å†…å®¹ï¼ˆå¿…å¡«ï¼‰
```js
callback(err: Error | null, content: string | Buffer, sourceMap?: SourceMap, meta?: any)
```
* é¿å…å¤šæ¬¡è°ƒç”¨ï¼šä¸€ä¸ª Loader ä¸­ this.async() åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¤šæ¬¡è°ƒç”¨ä¼šå¯¼è‡´é”™è¯¯ã€‚
* ä¸åŒæ­¥ Loader çš„åŒºåˆ«ï¼š
    * åŒæ­¥ Loader ç›´æ¥è¿”å›å¤„ç†ç»“æœï¼ˆreturn contentï¼‰ã€‚
    * å¼‚æ­¥ Loader ä¸èƒ½è¿”å›ç»“æœï¼Œå¿…é¡»é€šè¿‡ callback ä¼ é€’ã€‚


[åŸºäºthis.async()ï¼Œå®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„å¼‚æ­¥ Loader](./code/å®ç°ä¸€ä¸ªè‡ªå®šä¹‰loader/webpack.config.js)

## äºŒã€ä½¿ç”¨æ–¹å¼
Loader åœ¨ Webpack é…ç½®çš„ module.rules ä¸­å®šä¹‰ï¼Œé€šè¿‡ test åŒ¹é…æ–‡ä»¶ç±»å‹ï¼Œuse æŒ‡å®šä½¿ç”¨çš„ Loaderï¼Œé€šè¿‡useä¸­çš„options ä¸º Loader **ä¼ é€’å‚æ•°**

```js
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.css$/, // åŒ¹é…æ‰€æœ‰ .css æ–‡ä»¶
        include: path.resolve(__dirname, 'src'), // åªå¤„ç† src ç›®å½•ä¸‹çš„ .ts æ–‡ä»¶
        exclude: /node_modules/, // æ’é™¤ node_modules
        use: ['style-loader', 
             {
                loader: 'css-loader',
                options: { modules: true } // å¯ç”¨ CSS Modules
             }
        ]
      }
    ]
  }
};
```

## ä¸‰ã€å¸¸è§ Loader
### 1. å¤„ç†æ ·å¼æ–‡ä»¶çš„Loader
* style-loaderï¼šå°†cssæ·»åŠ åˆ°DOMä¸­ï¼ˆé€šè¿‡```<style>```ï¼‰ 
    > æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ ```MiniCssExtractPlugin.loader``` æ›¿ä»£ï¼Œå°† CSS æå–ä¸ºç‹¬ç«‹æ–‡ä»¶ã€‚
* css-loaderï¼šè§£æ CSS æ–‡ä»¶ä¸­çš„ @import å’Œ url() è¯­æ³•ï¼Œå°† CSS è½¬æ¢ä¸ºæ¨¡å—ã€‚å…³é”®å‚æ•°ï¼š
    * modules: trueï¼šå¯ç”¨ CSS Modulesï¼Œé¿å…æ ·å¼å†²çªã€‚
* less-loader: å¤„ç†lessï¼Œâ€‹éœ€å®‰è£…å¯¹åº”é¢„å¤„ç†å™¨ Less
* sass-loader: å¤„ç†sassâ€‹ï¼Œâ€‹éœ€å®‰è£…å¯¹åº”é¢„å¤„ç†å™¨ Sass
* postcss-loader: é€šè¿‡ PostCSS å¤„ç† CSSï¼ˆå¦‚è‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€ã€è½¬æ¢ CSS æ–°ç‰¹æ€§ï¼‰ï¼Œéœ€é…åˆ postcss.config.js ä¸€èµ·æ¥é…ç½®ã€‚

```js
rules: [
  {
    test: /\.less$/,
    use: [
      'style-loader', // æ³¨å…¥åˆ° DOM
      'css-loader',   // è§£æ CSS æ¨¡å—
      'postcss-loader', // è‡ªåŠ¨åŠ å‰ç¼€ç­‰
      'less-loader'   // è½¬æ¢ Less ä¸º CSS
    ]
  }
]
```
### 2. å¤„ç†å›¾ç‰‡/å­—ä½“ç­‰èµ„æºçš„ Loader
* file-loaderï¼šå°†æ–‡ä»¶å¤åˆ¶åˆ°è¾“å‡ºç›®å½•ï¼Œå¹¶è¿”å›æ–‡ä»¶çš„è®¿é—®è·¯å¾„ï¼ˆé€‚ç”¨äºå¤§å›¾ç‰‡ã€å­—ä½“ç­‰ï¼‰ã€‚
* url-loaderï¼šå°†**å°æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ã€å­—ä½“ï¼‰è½¬æ¢ä¸º DataURL**ï¼ˆBase64 ç¼–ç ï¼‰ï¼Œå‡å°‘ HTTP è¯·æ±‚ï¼›**å¤§æ–‡ä»¶åˆ™è‡ªåŠ¨è°ƒç”¨ file-loader è¾“å‡ºä¸ºå•ç‹¬æ–‡ä»¶**ã€‚å…³é”®å‚æ•°ï¼š
    * limit: 8192ï¼šæ–‡ä»¶å¤§å°é˜ˆå€¼ï¼ˆå•ä½å­—èŠ‚ï¼‰ï¼Œå°äºè¯¥å€¼è½¬ Base64ã€‚
    * name: ```'assets/[name].[hash:8].[ext]'```ï¼šè¾“å‡ºæ–‡ä»¶è·¯å¾„å’Œåç§°ã€‚

æ³¨æ„ï¼šWebpack 5 å·²å†…ç½® ```asset/resource``` ç±»å‹æ›¿ä»£ file-loaderï¼Œ```asset/inline```æ›¿ä»£ url-loaderã€‚

### 3. å¤„ç† JS/TS çš„ Loader
* babel-loaderï¼šé€šè¿‡ Babel å°† ES6+ è¯­æ³•è½¬æ¢ä¸º ES5ï¼Œå…¼å®¹æ—§æµè§ˆå™¨ã€‚
    * éœ€å®‰è£… @babel/coreã€@babel/preset-env ç­‰æ ¸å¿ƒåŒ…ã€‚
    * é€šè¿‡ .babelrc å®šä¹‰è½¬æ¢è§„åˆ™ã€‚
```JS
rules: [
  {
    test: /\.js$/,
    exclude: /node_modules/,
    use: {
      loader: 'babel-loader',
      options: {
        presets: ['@babel/preset-env'] // è½¬æ¢ ES6+ è¯­æ³•
      }
    }
  }
]
```
* ts-loaderï¼šå°† TS è½¬ä¸º JSï¼Œéœ€é…åˆ tsconfig.json é…ç½®ã€‚

### 4. å…¶ä»–Loader
* eslint-loaderï¼šåœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­æ‰§è¡Œ ESLint æ£€æŸ¥ï¼Œæå‰å‘ç°**ä»£ç è§„èŒƒé—®é¢˜**ï¼Œ**Webpack 5 æ¨èä½¿ç”¨ eslint-webpack-plugin æ›¿ä»£**
* vue-loaderï¼šè§£æ Vue å•æ–‡ä»¶ç»„ä»¶ï¼ˆ.vueï¼‰ï¼Œåˆ†ç¦»æ¨¡æ¿ã€è„šæœ¬å’Œæ ·å¼ã€‚
* html-loaderï¼šå°† HTML æ–‡ä»¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œæ”¯æŒè§£æå…¶ä¸­çš„ img æ ‡ç­¾è·¯å¾„ã€‚
* html-minify-loader: å‹ç¼©HTMLâ€‹ï¼Œç”¨ html-webpack-plugin æ›¿ä»£ï¼Œç›´æ¥ä½¿ç”¨å…¶ minify é…ç½®ï¼š
```js
new HtmlWebpackPlugin({
  template: './src/index.html',
  minify: {
    collapseWhitespace: true,
    removeComments: true
  }
})
```
