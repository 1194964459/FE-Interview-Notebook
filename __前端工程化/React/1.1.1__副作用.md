# 常见副作用

在 React 中，“副作用” 指**对组件外部环境产生影响** 或 **依赖外部环境的操作**，常见场景包括：

* 手动修改 DOM（如操作 canvas、播放动画）
* 数据获取（如 API 请求）
* 订阅事件（如 window.scroll、WebSocket）
* 设置定时器/计时器（setTimeout、setInterval）
* 修改全局变量
* 初始化第三方插件
* setState：因为它会触发 “重渲染”，进而可能影响父组件、兄弟组件的渲染

> setState 是副作用：因为它会修改组件状态并触发重渲染，影响组件的输出 UI（属于组件外部可见的变化），且可能被 React 异步合并（结果不唯一）。   
> 网络请求是副作用：依赖网络环境，结果可能成功/失败，且会与服务器交互（影响外部系统）。  
> DOM 操作是副作用：直接修改浏览器 DOM（组件外部环境），可能导致 React 虚拟 DOM 与真实 DOM 不一致。  
> 事件订阅/定时器是副作用：会在组件外部注册回调（如 window.addEventListener），即使组件卸载仍可能执行，需要手动清理。

## React 组件的原则：渲染与副作用分离
### 1. “渲染”（Render）是啥?
PS：在render方法之前执行

* “渲染”的本质：
    React 中的 “渲染”（Render）是一个**纯函数过程**，核心任务是：
    **根据当前的 props 和 state，计算出 “应该生成什么样的 UI”**（即返回 JSX 结构），不涉及任何状态修改、DOM 操作、setState或外部交互。

    简单说，**渲染的逻辑是 “无副作用的计算**”：
    * ```输入（props/state）固定 → 输出（JSX）必然固定```；
    * 过程中不会修改任何外部状态（包括组件自身的 state），也不会产生 “后续影响”。
    
* 渲染执行时机：**在render方法之前执行**
* 渲染阶段方法：getDerivedStateFromProps → shouldComponentUpdate → render（均在 render 前后，无副作用）。

疑问❓：setState是渲染吗?   
答：不是，**渲染是 “用 state 算 UI”，而 setState 是 “改 state”**—— 前者是 “计算”，后者是 “修改源头”，二者是 “因果关系”（setState 是 “因”，渲染是 “果”），但不是 “同类操作”。



### 2. React中的副作用一般放在哪个生命周期中？
PS：在render方法之后执行

副作用：“对函数/组件外部产生影响的操作”，比如数据请求、订阅事件、操作 DOM、设置定时器等。

核心原则：**副作用应在组件渲染完成后执行，且需在组件卸载前清理**，以保证组件行为可预测，避免内存泄漏。

应该在这些地方执行：
* 类组件：componentDidMount、componentDidUpdate、componentWillUnmount
* 函数组件：副作用用 useEffect 处理

为什么其他地方不能放副作用？
* render 方法：会被频繁调用（每次渲染都执行），可能导致性能问题或重复执行（```如多次发送请求```）。
* 旧生命周期（如 componentWillMount、componentWillUpdate）：在 Fiber 架构下可能被中断和重启，导致副作用多次执行（```如重复订阅事件，事件触发时 会被多次调用，若没被正确移除，可能导致内存泄漏！```）。
* getDerivedStateFromProps：```静态方法，设计为纯函数```，不允许有副作用（如数据请求、DOM 操作）。
