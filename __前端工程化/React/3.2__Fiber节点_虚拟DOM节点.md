# Fiber 树和虚拟 DOM 树

### 一、虚拟 DOM 树  
虚拟 DOM 是对真实 DOM 的**轻量级 JavaScript 对象表示**，它描述了 UI 的结构、属性和内容，是 React **跨平台渲染**（如 Web、React Native）的基础。

```js
{
  type: 'div',
  props: { className: 'container' },
  children: [
    { type: 'span', props: {}, children: 'Hello' }
  ]
}
```

UI 描述层
无调度信息：仅包含 UI 结构信息，不涉及渲染调度、优先级等执行层面的逻辑。

### 二、Fiber 树
Fiber 树是 React Fiber 架构中**用于执行渲染和调度的工作单元树**，它**在虚拟 DOM 树的基础上，增加了调度所需的元数据**，是 React 实现可中断渲染、优先级调度的核心载体。

* 渲染任务**拆分为细粒度的单元（**每个 Fiber 节点对应一个任务），
* 通过**链表结构**支持**可中断遍历**，
* 结合**优先级机制**决定任务执行顺序，确保*高优先级任务（如用户输入）优先响应*。


每个Fiber节点：在虚拟 DOM 节点上，增加了链表指针（child/sibling/return）、优先级（priority）、副作用标记（flags）等调度信息。```Fiber 节点 = 虚拟 DOM 信息 + 调度控制信息```

双缓存机制：存在「当前树（Current Tree）」和「工作树（WorkInProgress Tree）」两棵 Fiber 树


```js
const fiberNode = {
  // 1. 组件/元素基本信息
  type: null,          // 组件类型（如函数组件、类组件、DOM标签名）
  key: null,           // 用于列表Diff的唯一标识（同组件的key属性）
  props: null,         // 组件接收的props
  stateNode: null,     // 关联的真实DOM节点或组件实例（类组件）

  // 2. 链表结构（构建Fiber树）
  child: null,         // 第一个子Fiber节点（指向子节点）
  sibling: null,       // 下一个兄弟Fiber节点（指向同级节点）
  return: null,        // 父Fiber节点（指向父节点）

  // 3. 状态与更新相关
  memoizedState: null, // 组件当前的状态（如useState的状态、类组件的state）
  memoizedProps: null, // 上一次渲染时使用的props（用于对比更新）
  updateQueue: null,   // 待处理的更新队列（如setState产生的更新）

  // 4. 调度与优先级
  priority: 0,         // 任务优先级（决定执行顺序）
  expirationTime: 0,   // 过期时间（用于判断任务是否需要立即执行）
  suspenseConfig: null,// 与Suspense相关的配置（如超时时间）

  // 5. 副作用标记
  flags: 0,            // 节点需要执行的操作（如更新、删除、插入）
  subtreeFlags: 0,     // 子树中需要执行的副作用（批量标记）
  deletions: null,     // 待删除的子节点列表

  // 6. 双缓存相关
  alternate: null,     // 指向另一棵树中的对应节点（当前树与工作树的映射）
};
```
参考：[Fiber节点结构](https://www.doubao.com/thread/w7b8481b93b9118fc)


### 组件、元素 与 Fiber节点的对应关系
组件本身只对应一个 Fiber 节点，组件内的子元素对应各自的 Fiber 节点，通过 child（子节点）和 sibling（兄弟节点）指针与组件的 Fiber 节点关联。
