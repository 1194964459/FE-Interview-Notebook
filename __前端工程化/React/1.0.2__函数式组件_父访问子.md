# å‡½æ•°å¼ç»„ä»¶ä¸­ çˆ¶ç»„ä»¶ å¦‚ä½•è®¿é—® å­ç»„ä»¶å†…çš„æ–¹æ³•ã€å±æ€§ï¼Ÿ
å‚è€ƒï¼š[ç±»ç»„ä»¶ã€å‡½æ•°ç»„ä»¶çš„Ref ](./Ref.md)

å‡½æ•°ç»„ä»¶æ²¡æœ‰å®ä¾‹ï¼Œä¸èƒ½åƒç±»ç»„ä»¶é‚£æ ·ç›´æ¥æ¥æ”¶ ref å±æ€§ã€‚å› æ­¤éœ€è¦é€šè¿‡```forwardRef é…åˆ useImperativeHandle``` å®ç°çˆ¶ç»„ä»¶å¯¹å­ç»„ä»¶çš„è®¿é—®å’Œæ“ä½œã€‚

forwardRef æ˜¯ React æä¾›çš„ä¸€ä¸ªé«˜çº§å‡½æ•°ï¼Œç”¨äº```å°† ref ä»çˆ¶ç»„ä»¶â€œè½¬å‘â€åˆ°å­ç»„ä»¶çš„ å†…éƒ¨DOMå…ƒç´  æˆ– ç»„ä»¶```

## ä¸€ã€forwardRef
forwardRef **æ¥æ”¶ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ä½œä¸ºå‚æ•°**ï¼Œè¯¥å‡½æ•°çš„æ ¼å¼ä¸ºï¼š```(props, ref) => ReactNode```

ä¸æ™®é€šå‡½æ•°ç»„ä»¶ä¸åŒï¼Œè¿™ä¸ªæ¸²æŸ“å‡½æ•°ä¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š   
* propsï¼šçˆ¶ç»„ä»¶ä¼ é€’çš„å±æ€§
* refï¼šçˆ¶ç»„ä»¶ä¼ é€’çš„ ref å¯¹è±¡ï¼ˆéœ€è¦è½¬å‘ç»™å†…éƒ¨å…ƒç´ ï¼‰
> ğŸ“¢æ³¨æ„ï¼šref ä¸æ˜¯ propsï¼Œè½¬å‘çš„ ref ä¸ä¼šå‡ºç°åœ¨å­ç»„ä»¶çš„ props ä¸­ï¼Œéœ€è¦å•ç‹¬ä½œä¸ºå‚æ•°æ¥æ”¶ã€‚

ç¤ºä¾‹ï¼šè½¬å‘ ref åˆ° DOM å…ƒç´ 

```js
import React, { forwardRef } from'react';

// 1. ä½¿ç”¨ forwardRef åˆ›å»ºå¯æ¥æ”¶ ref çš„å­ç»„ä»¶
const CustomInput = forwardRef((props, ref) => {
  // 3. å°†çˆ¶ç»„ä»¶ä¼ é€’çš„ ref ç»‘å®šåˆ°å†…éƒ¨ input å…ƒç´ 
  return <input {...props} ref={ref} />;
});

// 2. çˆ¶ç»„ä»¶ä½¿ç”¨ CustomInput å¹¶ä¼ é€’ ref
function ParentComponent() {
  // åˆ›å»ºä¸€ä¸ª ref
  const inputRef = React.useRef(null);

  const focusInput = () => {
    // 4. çˆ¶ç»„ä»¶é€šè¿‡ ref ç›´æ¥è®¿é—®å­ç»„ä»¶å†…éƒ¨çš„ input å…ƒç´ 
    inputRef.current.focus();
  };

  return (
    <div>
      <CustomInput ref={inputRef} placeholder="è¯·è¾“å…¥å†…å®¹" />
      <button onClick={focusInput}>èšç„¦è¾“å…¥æ¡†</button>
    </div>
  );
}
```

å·¥ä½œæµç¨‹ï¼š
* çˆ¶ç»„ä»¶åˆ›å»º inputRef å¹¶ä¼ é€’ç»™ CustomInput ç»„ä»¶ã€‚
* CustomInput é€šè¿‡ forwardRef æ¥æ”¶ ref å‚æ•°ã€‚
* CustomInput å°† ref ç»‘å®šåˆ°è‡ªèº«å†…éƒ¨çš„ ```<input> å…ƒç´ ```ã€‚
* çˆ¶ç»„ä»¶é€šè¿‡ inputRef.current ç›´æ¥è®¿é—®å­ç»„ä»¶å†…éƒ¨çš„```<input> å…ƒç´ ```ã€‚

## äºŒã€ä¸ useImperativeHandle é…åˆï¼ˆè‡ªå®šä¹‰æš´éœ²å†…å®¹ï¼‰

é»˜è®¤æƒ…å†µä¸‹ï¼Œè½¬å‘çš„ ref ä¼šç›´æ¥æŒ‡å‘å­ç»„ä»¶çš„ DOM å…ƒç´ ã€‚å¦‚æœå¸Œæœ›è‡ªå®šä¹‰æš´éœ²ç»™çˆ¶ç»„ä»¶çš„å†…å®¹ï¼ˆè€Œéç›´æ¥æš´éœ² DOM å…ƒç´ ï¼‰ï¼Œå¯ä»¥ç»“åˆ useImperativeHandleï¼š

è¯­æ³•å¦‚ä¸‹ï¼š
```js
useImperativeHandle(ref, () => ({
  // è‡ªå®šä¹‰æš´éœ²çš„æ–¹æ³•æˆ–å±æ€§
  method1: () => {... },
  property1: value,...
}), [deps]);
```
useImperativeHandle æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼š   
* refï¼šé€šè¿‡ forwardRef ä¼ é€’çš„ ref å¯¹è±¡ï¼ˆéœ€è¦è‡ªå®šä¹‰å…¶æš´éœ²å†…å®¹ï¼‰ã€‚
* createHandleï¼šä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå³è‡ªå®šä¹‰æš´éœ²ç»™çˆ¶ç»„ä»¶çš„å†…å®¹ï¼ˆå±æ€§æˆ–æ–¹æ³•ï¼‰ã€‚
* depsï¼šä¾èµ–æ•°ç»„ï¼Œå½“ä¾èµ–å˜åŒ–æ—¶ï¼ŒcreateHandle ä¼šé‡æ–°æ‰§è¡Œï¼Œç”Ÿæˆæ–°çš„æš´éœ²å†…å®¹ã€‚

ç¤ºä¾‹ï¼š
```js
import React, { forwardRef, useRef, useImperativeHandle } from'react';

const CustomInput = forwardRef((props, ref) => {
  // å­ç»„ä»¶å†…éƒ¨çš„çœŸå® DOM ref
  const internalRef = useRef(null);

  // è‡ªå®šä¹‰æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•ï¼ˆè¦†ç›–é»˜è®¤çš„ ref è¡Œä¸ºï¼‰
  useImperativeHandle(ref, () => ({
    // åªæš´éœ² focus æ–¹æ³•ï¼Œä¸æš´éœ²å®Œæ•´ DOM å…ƒç´ 
    focus: () => {
      internalRef.current.focus();
    },
    // é¢å¤–æš´éœ²ä¸€ä¸ªè‡ªå®šä¹‰æ–¹æ³•
    clear: () => {
      internalRef.current.value = '';
    }
  }));

  return <input ref={internalRef} {...props} />;
});

// çˆ¶ç»„ä»¶åªèƒ½è®¿é—®åˆ°è‡ªå®šä¹‰æš´éœ²çš„æ–¹æ³•
function Parent() {
  const inputRef = useRef(null);

  const handleClick = () => {
    inputRef.current.focus(); // è°ƒç”¨è‡ªå®šä¹‰çš„ focus æ–¹æ³•
    inputRef.current.clear(); // è°ƒç”¨è‡ªå®šä¹‰çš„ clear æ–¹æ³•
    // inputRef.current.value = 'xxx'; // é”™è¯¯ï¼æ— æ³•è®¿é—® DOM åŸç”Ÿå±æ€§
  };

  return (
    <div>
      <CustomInput placeholder="æµ‹è¯•" />
      <button onClick={handleClick}>æ“ä½œè¾“å…¥æ¡†</button>
    </div>
  );
}
```

è¿™é‡Œæœ‰2ä¸ªrefï¼š
1. çˆ¶ç»„ä»¶ä¼ é€’çš„refï¼ˆforwardRef æ¥æ”¶çš„ refï¼‰  
    * **çˆ¶ç»„ä»¶ â€œæƒ³è¦è®¿é—®å­ç»„ä»¶â€ çš„ â€œå…¥å£â€**ï¼Œä½†æ˜¯**è¿™ä¸ª ref æœ¬èº«ä¸ç›´æ¥å…³è” DOM**ï¼Œè€Œæ˜¯**é€šè¿‡ useImperativeHandle è¢« â€œé‡å®šå‘â€ åˆ°å­ç»„ä»¶è‡ªå®šä¹‰çš„è¡Œä¸º**ã€‚

2. å­ç»„ä»¶å†…éƒ¨çš„internalRefï¼ˆuseRef åˆ›å»ºçš„ refï¼‰
    * **ç›´æ¥å…³è”å­ç»„ä»¶å†…éƒ¨çš„ DOM å…ƒç´ **ï¼Œå¤–æ˜¯éšè—çš„ï¼ˆçˆ¶ç»„ä»¶æ— æ³•ç›´æ¥é€šè¿‡çˆ¶çº§ ref è®¿é—®åˆ°è¿™ä¸ª internalRefï¼‰ã€‚

### ä¸ºä»€ä¹ˆå­ç»„ä»¶è¦å†åˆ›å»ºä¸€ä¸ª internalRefï¼Ÿ
ä¸»è¦æ˜¯ä¸ºäº† â€œè§£è€¦â€ å’Œ â€œå°è£…â€ï¼š
* **è§£è€¦çˆ¶ç»„ä»¶ä¸ DOM ç»†èŠ‚**ï¼šçˆ¶ç»„ä»¶ä¸éœ€è¦çŸ¥é“å­ç»„ä»¶å†…éƒ¨DOMå…·ä½“å®ç°ç»†èŠ‚ï¼Œåªéœ€è¦è°ƒç”¨focus æˆ– clear ç­‰â€œä¸šåŠ¡æ–¹æ³•â€ å³å¯ï¼Œé¿å…å­ç»„ä»¶æš´æ¼è¿‡å¤šå†…éƒ¨ç»†èŠ‚ï¼ˆç ´åå°è£…æ€§ï¼‰ã€‚
    * å¦‚æœç›´æ¥æŠŠçˆ¶çº§ref ç»‘å®šåˆ° DOMï¼ˆå³å»æ‰ internalRefï¼Œç›´æ¥ ref={ref}ï¼‰ï¼Œçˆ¶ç»„ä»¶å°±èƒ½æ‹¿åˆ°å®Œæ•´çš„ DOM å…ƒç´ 
* **è‡ªå®šä¹‰æš´éœ²çš„è¡Œä¸º**ï¼šé€šè¿‡ internalRef æ“ä½œ DOMï¼Œå†é€šè¿‡ useImperativeHandle æŠŠ â€œç»è¿‡åŒ…è£…çš„æ–¹æ³•â€ æš´éœ²ç»™çˆ¶ç»„ä»¶ï¼Œå­ç»„ä»¶å¯ä»¥ç²¾ç¡®æ§åˆ¶çˆ¶ç»„ä»¶èƒ½åšä»€ä¹ˆã€‚
    * å¦‚ï¼šçˆ¶ç»„ä»¶è°ƒç”¨ focus æ—¶ï¼Œå­ç»„ä»¶ç¡®ä¿ç„¦ç‚¹é€»è¾‘æ­£ç¡®æ‰§è¡Œã€‚


## ä¸‰ã€ç±»ç»„ä»¶ä¸­ï¼šçˆ¶ç»„ä»¶å¦‚ä½•è·å–å­ç»„ä»¶çš„æ–¹æ³•ã€å±æ€§ï¼Ÿ

```js
import { Component, createRef } from'react';

// 1. å­ç»„ä»¶ï¼ˆç±»ç»„ä»¶ï¼‰ï¼šå®šä¹‰å…¬å¼€æ–¹æ³•å’Œå±æ€§
class ChildComponent extends Component {
  constructor(props) {
    super(props);
    this.state = { count: 0 };
  }

  // å…¬å¼€æ–¹æ³•ï¼ˆä¾›çˆ¶ç»„ä»¶è°ƒç”¨ï¼‰
  internalMethod = () => {
    this.setState(prev => ({ count: prev.count + 1 }));
  };

  // å…¬å¼€å±æ€§ï¼ˆä¹Ÿå¯é€šè¿‡ getter æš´éœ²ï¼‰
  get currentCount() {
    return this.state.count;
  }

  render() {
    return <div>å­ç»„ä»¶è®¡æ•°ï¼š{this.state.count}</div>;
  }
}

// 2. çˆ¶ç»„ä»¶ï¼šé€šè¿‡ ref è®¿é—®å­ç»„ä»¶å®ä¾‹
class ParentComponent extends Component {
  constructor(props) {
    super(props);
    this.childRef = createRef(null); // åˆ›å»º ref
  }

  handleClick = () => {
    // è°ƒç”¨å­ç»„ä»¶çš„å…¬å¼€æ–¹æ³•
    this.childRef.current.internalMethod();
    console.log('å­ç»„ä»¶å½“å‰è®¡æ•°ï¼š', this.childRef.current.currentCount);
  };

  render() {
    return (
      <div>
        <ChildComponent ref={this.childRef} /> {/* ç»‘å®š ref åˆ°å­ç»„ä»¶ */}
        <button onClick={this.handleClick}>è°ƒç”¨å­ç»„ä»¶æ–¹æ³•</button>
        <button onClick={this.handleReset}>é‡ç½®å­ç»„ä»¶è®¡æ•°</button>
      </div>
    );
  }
}
```
