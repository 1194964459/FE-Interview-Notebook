# äº‹ä»¶å¾ªç¯ (event loop)

## å‚è€ƒæ–‡ç« ï¼š
1. æ¦‚è§ˆï¼šhttps://juejin.cn/post/6844903761949753352#heading-13
2. æ¦‚è§ˆï¼šhttps://zhuanlan.zhihu.com/p/33058983
3. Node äº‹ä»¶å¾ªç¯ï¼šhttp://lynnelv.github.io/js-event-loop-nodejs

## ä¸»è¦éœ€è¦äº†è§£çš„å†…å®¹ï¼š
1. JSä¸ºä»€ä¹ˆæ˜¯ä¸€ç§å•çº¿ç¨‹çš„è¯­è¨€ï¼Ÿä¸ºä»€ä¹ˆä¸é˜»å¡ï¼Ÿ
2. è¿›ç¨‹/çº¿ç¨‹
3. æµè§ˆå™¨å†…æ ¸
4. æµè§ˆå™¨äº‹ä»¶å¾ªç¯
5. Nodeäº‹ä»¶å¾ªç¯ï¼Œ
6. Node/æµè§ˆå™¨ äº‹ä»¶å¾ªç¯çš„å¼‚åŒ;

## 1.jsä¸ºä»€ä¹ˆæ˜¯ä¸€ç§å•çº¿ç¨‹çš„è¯­è¨€ï¼Ÿä¸ºä»€ä¹ˆä¸é˜»å¡ï¼Ÿ
javascriptä»è¯ç”Ÿä¹‹æ—¥èµ·å°±æ˜¯ä¸€é—¨'å•çº¿ç¨‹'çš„'éé˜»å¡'çš„è„šæœ¬è¯­è¨€ã€‚è¿™æ˜¯ç”±å…¶æœ€åˆçš„ç”¨é€”æ¥å†³å®šçš„ï¼šä¸æµè§ˆå™¨äº¤äº’ã€‚
1. å•çº¿ç¨‹: javascriptä»£ç åœ¨æ‰§è¡Œçš„ä»»ä½•æ—¶å€™ï¼Œéƒ½'åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹'æ¥å¤„ç†æ‰€æœ‰çš„ä»»åŠ¡ã€‚
2. éé˜»å¡: åˆ™æ˜¯å½“ä»£ç éœ€è¦è¿›è¡Œä¸€é¡¹å¼‚æ­¥ä»»åŠ¡(ä¸èƒ½ç«‹åˆ»è¿”å›ç»“æœ)çš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹ä¼šæŒ‚èµ·ï¼ˆpendingï¼‰è¿™ä¸ªä»»åŠ¡ï¼Œç„¶ååœ¨'å¼‚æ­¥ä»»åŠ¡è¿”å›ç»“æœçš„æ—¶å€™'å†æ ¹æ®ä¸€å®šè§„åˆ™å»æ‰§è¡Œç›¸åº”çš„å›è°ƒ.

å•çº¿ç¨‹çš„å¿…è¦æ€§ï¼šåŸå› ä¹‹ä¸€æ˜¯ JS æœ€åˆã€æœ€ä¸»è¦çš„æ‰§è¡Œç¯å¢ƒâ€”â€”æ˜¯åœ¨ æµè§ˆå™¨ ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œå„ç§å„æ ·çš„domæ“ä½œã€‚è¯•æƒ³ä¸€ä¸‹ å¦‚æœjavascriptæ˜¯å¤šçº¿ç¨‹çš„ï¼Œé‚£ä¹ˆå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹domè¿›è¡Œä¸€é¡¹æ“ä½œï¼Œä¾‹å¦‚ä¸€ä¸ªå‘å…¶æ·»åŠ äº‹ä»¶ï¼Œè€Œå¦ä¸€ä¸ªåˆ é™¤äº†è¿™ä¸ªdomï¼Œæ­¤æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

## 2.è¿›ç¨‹/çº¿ç¨‹
è¿›ç¨‹æ˜¯ CPUèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼›çº¿ç¨‹æ˜¯ CPUè°ƒåº¦çš„æœ€å°å•ä½ã€‚
è¿›ç¨‹/çº¿ç¨‹å…³ç³»ï¼š
    1. ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„æˆï¼›
    2. ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´æ˜¯å…±äº«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ç”¨è¿™äº›å…±äº«å†…å­˜ã€‚

## 3.æµè§ˆå™¨å†…æ ¸
æµè§ˆå™¨å†…æ ¸æ˜¯å¤šçº¿ç¨‹ï¼Œåœ¨å†…æ ¸æ§åˆ¶ä¸‹å„çº¿ç¨‹ç›¸äº’é…åˆä»¥ä¿æŒåŒæ­¥ï¼Œä¸€ä¸ªæµè§ˆå™¨é€šå¸¸ç”±ä»¥ä¸‹å¸¸é©»çº¿ç¨‹ç»„æˆï¼š
* GUI æ¸²æŸ“çº¿ç¨‹
* JavaScriptå¼•æ“çº¿ç¨‹
* å®šæ—¶è§¦å‘å™¨çº¿ç¨‹
* äº‹ä»¶è§¦å‘çº¿ç¨‹
* å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹

1.GUIæ¸²æŸ“çº¿ç¨‹
> * ä¸»è¦è´Ÿè´£é¡µé¢çš„æ¸²æŸ“ï¼Œè§£æHTMLã€CSSï¼Œæ„å»ºDOMæ ‘ï¼Œå¸ƒå±€å’Œç»˜åˆ¶ç­‰ã€‚
> * å½“ç•Œé¢éœ€è¦é‡ç»˜æˆ–è€…ç”±äºæŸç§æ“ä½œå¼•å‘'å›æµ'æ—¶ï¼Œå°†æ‰§è¡Œè¯¥çº¿ç¨‹ã€‚
> * è¯¥çº¿ç¨‹ä¸'JSå¼•æ“çº¿ç¨‹'äº’æ–¥ï¼Œå½“æ‰§è¡ŒJSå¼•æ“çº¿ç¨‹æ—¶ï¼ŒGUIæ¸²æŸ“ä¼šè¢«æŒ‚èµ·ï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—ç©ºé—²æ—¶ï¼Œä¸»çº¿ç¨‹æ‰ä¼šå»æ‰§è¡ŒGUIæ¸²æŸ“ã€‚

2.JSå¼•æ“çº¿ç¨‹
> * ä¸»è¦è´Ÿè´£å¤„ç† JavaScriptè„šæœ¬ï¼Œæ‰§è¡Œä»£ç ã€‚
> * ä¸»è¦è´Ÿè´£æ‰§è¡Œå‡†å¤‡å¥½å¾…æ‰§è¡Œçš„äº‹ä»¶ï¼Œå³å®šæ—¶å™¨è®¡æ•°ç»“æŸï¼Œæˆ–è€…å¼‚æ­¥è¯·æ±‚æˆåŠŸå¹¶æ­£ç¡®è¿”å›æ—¶ï¼Œå°†ä¾æ¬¡è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…JSå¼•æ“çº¿ç¨‹çš„æ‰§è¡Œã€‚
> * è¯¥çº¿ç¨‹ä¸'GUIæ¸²æŸ“çº¿ç¨‹'äº’æ–¥ï¼Œå½“ JSå¼•æ“çº¿ç¨‹æ‰§è¡Œ JavaScriptè„šæœ¬æ—¶é—´è¿‡é•¿ï¼Œå°†å¯¼è‡´é¡µé¢æ¸²æŸ“çš„é˜»å¡ã€‚
> * JSå¼•æ“ é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
> > è¯æ³•åˆ†æï¼šå°†æºä»£ç åˆ†è§£ä¸ºæœ‰æ„ä¹‰çš„åˆ†è¯
> > è¯­æ³•åˆ†æï¼šç”¨è¯­æ³•åˆ†æå™¨å°†åˆ†è¯è§£ææˆè¯­æ³•æ ‘
> > ä»£ç ç”Ÿæˆï¼šç”Ÿæˆæœºå™¨èƒ½è¿è¡Œçš„ä»£ç 
> > ä»£ç æ‰§è¡Œ

3.å®šæ—¶å™¨è§¦å‘çº¿ç¨‹
> * è´Ÿè´£æ‰§è¡Œå¼‚æ­¥å®šæ—¶å™¨ä¸€ç±»çš„å‡½æ•°çš„çº¿ç¨‹ï¼Œå¦‚ï¼š setTimeoutï¼ŒsetIntervalã€‚
> * ä¸»çº¿ç¨‹ä¾æ¬¡æ‰§è¡Œä»£ç æ—¶ï¼Œé‡åˆ°'å®šæ—¶å™¨'ï¼Œä¼šå°†å®šæ—¶å™¨äº¤ç»™è¯¥çº¿ç¨‹å¤„ç†ï¼Œå½“è®¡æ•°å®Œæ¯•åï¼Œäº‹ä»¶è§¦å‘çº¿ç¨‹ä¼šå°†'è®¡æ•°å®Œæ¯•åçš„äº‹ä»¶'åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç­‰å¾…JSå¼•æ“çº¿ç¨‹æ‰§è¡Œã€‚

4.äº‹ä»¶è§¦å‘çº¿ç¨‹
> * ä¸»è¦è´Ÿè´£å°†å‡†å¤‡å¥½çš„äº‹ä»¶äº¤ç»™ JSå¼•æ“çº¿ç¨‹æ‰§è¡Œã€‚
> * æ¯”å¦‚ setTimeoutå®šæ—¶å™¨è®¡æ•°ç»“æŸï¼Œ ajaxç­‰å¼‚æ­¥è¯·æ±‚æˆåŠŸå¹¶è§¦å‘å›è°ƒå‡½æ•°ï¼Œæˆ–è€…ç”¨æˆ·è§¦å‘ç‚¹å‡»äº‹ä»¶æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šå°†æ•´è£…å¾…å‘çš„äº‹ä»¶ä¾æ¬¡åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œç­‰å¾… JSå¼•æ“çº¿ç¨‹çš„æ‰§è¡Œã€‚

5.å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹
> * è´Ÿè´£æ‰§è¡Œå¼‚æ­¥è¯·æ±‚ä¸€ç±»çš„å‡½æ•°çš„çº¿ç¨‹ï¼Œå¦‚ï¼š Promiseï¼Œaxiosï¼Œajaxç­‰ã€‚
> * ä¸»çº¿ç¨‹ä¾æ¬¡æ‰§è¡Œä»£ç æ—¶ï¼Œé‡åˆ°'å¼‚æ­¥è¯·æ±‚'ï¼Œä¼šå°†å‡½æ•°äº¤ç»™è¯¥çº¿ç¨‹å¤„ç†ï¼Œå½“ç›‘å¬åˆ°çŠ¶æ€ç å˜æ›´ï¼Œ'å¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œäº‹ä»¶è§¦å‘çº¿ç¨‹'ä¼šå°†å›è°ƒå‡½æ•°åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç­‰å¾…JSå¼•æ“çº¿ç¨‹æ‰§è¡Œã€‚

## 4.æµè§ˆå™¨äº‹ä»¶å¾ªç¯
### 1. Micro-Task ä¸ Macro-Task
æµè§ˆå™¨ç«¯äº‹ä»¶å¾ªç¯ä¸­çš„å¼‚æ­¥é˜Ÿåˆ—æœ‰ä¸¤ç§ï¼šmacroï¼ˆå®ä»»åŠ¡ï¼‰é˜Ÿåˆ—å’Œ microï¼ˆå¾®ä»»åŠ¡ï¼‰é˜Ÿåˆ—ã€‚å®ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥æœ‰å¤šä¸ªï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—åªæœ‰ä¸€ä¸ªã€‚ 

**å¸¸è§çš„ å®ä»»åŠ¡**ï¼š
|  -   | æµè§ˆå™¨  | Node  |
|  ----  | ----  | ----  |
| I/O  | âˆš | âˆš |
| setTimeout  | âˆš | âˆš |
| setInterval  | âˆš | âˆš |
| setImmediate  | Ã— | âˆš |
| requestAnimationFrame  | âˆš | Ã— |
| script  | âˆš | Ã— |
| UIæ¸²æŸ“  | âˆš | Ã— |

**å¸¸è§çš„ å¾®ä»»åŠ¡**ï¼š
|  è¡¨å¤´   | æµè§ˆå™¨  | Node  |
|  ----  | ----  | ----  |
| process.nextTick	  | Ã— | âˆš |
| MutationObserver  | âˆš | Ã— |
| Promise.then catch finally | âˆš | âˆš |


### äº‹ä»¶å¾ªç¯è¿‡ç¨‹ï¼š  
![æµè§ˆå™¨äº‹ä»¶å¾ªç¯](./icon/browser-event-loop.jpg)

* ä¸€å¼€å§‹æ‰§è¡Œæ ˆç©º,æˆ‘ä»¬å¯ä»¥æŠŠ**æ‰§è¡Œæ ˆè®¤ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨å‡½æ•°è°ƒç”¨çš„æ ˆç»“æ„ï¼Œéµå¾ªå…ˆè¿›åå‡ºçš„åŸåˆ™**ã€‚micro é˜Ÿåˆ—ç©ºï¼Œmacro é˜Ÿåˆ—é‡Œæœ‰ä¸”åªæœ‰ä¸€ä¸ª script è„šæœ¬ï¼ˆæ•´ä½“ä»£ç ï¼‰ã€‚

* å…¨å±€ä¸Šä¸‹æ–‡ï¼ˆscript æ ‡ç­¾ï¼‰è¢«æ¨å…¥æ‰§è¡Œæ ˆï¼ŒåŒæ­¥ä»£ç æ‰§è¡Œã€‚åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šåˆ¤æ–­æ˜¯åŒæ­¥ä»»åŠ¡è¿˜æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œé€šè¿‡å¯¹ä¸€äº›æ¥å£çš„è°ƒç”¨ï¼Œå¯ä»¥äº§ç”Ÿæ–°çš„ macro-task ä¸ micro-taskï¼Œå®ƒä»¬ä¼šåˆ†åˆ«è¢«æ¨å…¥å„è‡ªçš„ä»»åŠ¡é˜Ÿåˆ—é‡Œã€‚åŒæ­¥ä»£ç æ‰§è¡Œå®Œäº†ï¼Œscript è„šæœ¬ä¼šè¢«ç§»å‡º macro é˜Ÿåˆ—ã€‚

* æ¥ä¸‹æ¥å¤„ç†çš„æ˜¯ micro-taskã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå½“ macro-task å‡ºé˜Ÿæ—¶ï¼Œä»»åŠ¡æ˜¯ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œçš„ï¼›è€Œ micro-task å‡ºé˜Ÿæ—¶ï¼Œä»»åŠ¡æ˜¯ä¸€é˜Ÿä¸€é˜Ÿæ‰§è¡Œçš„ã€‚

* æ‰§è¡Œæ¸²æŸ“æ“ä½œï¼Œæ›´æ–°ç•Œé¢

* æ£€æŸ¥æ˜¯å¦å­˜åœ¨ Web worker ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯¹å…¶è¿›è¡Œå¤„ç†

* ä¸Šè¿°è¿‡ç¨‹å¾ªç¯å¾€å¤ï¼Œç›´åˆ°ä¸¤ä¸ªé˜Ÿåˆ—éƒ½æ¸…ç©º


### äº‹ä»¶å¾ªç¯æ€»ç»“
å½“**å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•**æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†**æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—**ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»**å®ä»»åŠ¡é˜Ÿåˆ—**ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚æ‰§è¡Œå®ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°å¾®ä»»åŠ¡ï¼Œä¾æ¬¡åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

ğŸ“¢ å…¶ä»–å¯èƒ½æ··æ·†çš„ç‚¹ï¼š
* **new Promise æœ¬èº«æ˜¯åŒæ­¥æ‰§è¡Œçš„**ï¼ˆä»…åˆ›å»ºå®ä¾‹ï¼‰ï¼Œè€Œ **Promise çš„ â€œå¾®ä»»åŠ¡ç‰¹æ€§â€ ä½“ç°åœ¨ then/catch/finally ä¸­**ã€‚
* **æ‰§è¡Œå®ä»»åŠ¡æ—¶ï¼Œæœ‰ä¸ªå¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœºæ˜¯**ï¼Ÿ
    > äº‹ä»¶å¾ªç¯ä¼šåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œåœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œä¹‹å‰ï¼Œä¼˜å…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ã€‚åªæœ‰å½“å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºåï¼Œäº‹ä»¶å¾ªç¯æ‰ä¼šå»æ£€æŸ¥å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚   

## 5.Nodeäº‹ä»¶å¾ªç¯
![Node äº‹ä»¶å¾ªç¯](./icon/node-event-loop.jpg)

## 6.Node/æµè§ˆå™¨ äº‹ä»¶å¾ªç¯çš„å¼‚åŒ
1. æµè§ˆå™¨ç¯å¢ƒä¸‹ï¼Œmicrotaskçš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ¯ä¸ªmacrotaskæ‰§è¡Œå®Œä¹‹åæ‰§è¡Œã€‚
2. Node.jsä¸­ï¼Œmicrotaskä¼šåœ¨äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œå®Œæ¯•ï¼Œå°±ä¼šå»æ‰§è¡Œmicrotaské˜Ÿåˆ—çš„ä»»åŠ¡ã€‚

![å·®å¼‚](./icon/differences.jpg)

### 7. ç¤ºä¾‹ï¼š
```javascript
setTimeout(()=>{
    console.log('timer1')
    Promise.resolve().then(function() {
        console.log('promise1')
    })
}, 0)
setTimeout(()=>{
    console.log('timer2')
    Promise.resolve().then(function() {
        console.log('promise2')
    })
}, 0)
```
æµè§ˆå™¨ç«¯è¿è¡Œç»“æœï¼štimer1=>promise1=>timer2=>promise2
![æµè§ˆå™¨](https://user-gold-cdn.xitu.io/2019/1/12/16841d6392e8f537?imageslim)

Nodeç«¯è¿è¡Œç»“æœåˆ†ä¸¤ç§æƒ…å†µï¼š
1. node11ç‰ˆæœ¬ï¼šä¸€æ—¦æ‰§è¡Œä¸€ä¸ªé˜¶æ®µé‡Œçš„ä¸€ä¸ªå®ä»»åŠ¡(setTimeout,setIntervalå’ŒsetImmediate)å°±ç«‹åˆ»æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™å°±è·Ÿæµè§ˆå™¨ç«¯è¿è¡Œä¸€è‡´ï¼Œæœ€åçš„ç»“æœä¸ºtimer1=>promise1=>timer2=>promise2
2. node10åŠå…¶ä¹‹å‰ç‰ˆæœ¬ï¼šè¦çœ‹ç¬¬ä¸€ä¸ªå®šæ—¶å™¨æ‰§è¡Œå®Œï¼Œç¬¬äºŒä¸ªå®šæ—¶å™¨æ˜¯å¦åœ¨å®Œæˆé˜Ÿåˆ—ä¸­ã€‚

* å¦‚æœæ˜¯ç¬¬äºŒä¸ªå®šæ—¶å™¨è¿˜æœªåœ¨å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œæœ€åçš„ç»“æœä¸ºtimer1=>promise1=>timer2=>promise2
* å¦‚æœæ˜¯ç¬¬äºŒä¸ªå®šæ—¶å™¨å·²ç»åœ¨å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œåˆ™æœ€åçš„ç»“æœä¸ºtimer1=>timer2=>promise1=>promise2(ä¸‹æ–‡è¿‡ç¨‹è§£é‡ŠåŸºäºè¿™ç§æƒ…å†µä¸‹)
![node](https://user-gold-cdn.xitu.io/2019/1/12/16841d5f85468047?imageslim)


